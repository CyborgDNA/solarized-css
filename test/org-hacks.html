<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
               "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>Org ad hoc code, quick hacks and workarounds</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
<meta name="title" content="Org ad hoc code, quick hacks and workarounds"/>
<meta name="generator" content="Org-mode"/>
<meta name="generated" content="2012-06-01T16:21+0200"/>
<meta name="author" content="Worg people"/>
<meta name="description" content=""/>
<meta name="keywords" content=""/>
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  html { font-family: Times, serif; font-size: 12pt; }
  .title  { text-align: center; }
  .todo   { color: red; }
  .done   { color: green; }
  .tag    { background-color: #add8e6; font-weight:normal }
  .target { }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  {margin-left:auto; margin-right:0px;  text-align:right;}
  .left   {margin-left:0px;  margin-right:auto; text-align:left;}
  .center {margin-left:auto; margin-right:auto; text-align:center;}
  p.verse { margin-left: 3% }
  pre {
	border: 1pt solid #AEBDCC;
	background-color: #F3F5F7;
	padding: 5pt;
	font-family: courier, monospace;
        font-size: 90%;
        overflow:auto;
  }
  table { border-collapse: collapse; }
  td, th { vertical-align: top;  }
  th.right  { text-align:center;  }
  th.left   { text-align:center;   }
  th.center { text-align:center; }
  td.right  { text-align:right;  }
  td.left   { text-align:left;   }
  td.center { text-align:center; }
  dt { font-weight: bold; }
  div.figure { padding: 0.5em; }
  div.figure p { text-align: center; }
  div.inlinetask {
    padding:10px;
    border:2px solid gray;
    margin:10px;
    background: #ffffcc;
  }
  textarea { overflow-x: auto; }
  .linenr { font-size:smaller }
  .code-highlighted {background-color:#ffff00;}
  .org-info-js_info-navigation { border-style:none; }
  #org-info-js_console-label { font-size:10px; font-weight:bold;
                               white-space:nowrap; }
  .org-info-js_search-highlight {background-color:#ffff00; color:#000000;
                                 font-weight:bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="../solarized-light.css" />
<script type="text/javascript" src="../org-info.js"></script>
<script type="text/javascript" >
<!--/*--><![CDATA[/*><!--*/
org_html_manager.set("TOC_DEPTH", "3");
org_html_manager.set("LINK_HOME", "");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "info");
org_html_manager.setup();  // activate after the parameters are set
/*]]>*///-->
</script>
<script type="text/javascript">
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>

</head>
<body>

<div id="preamble">

</div>

<div id="content">
<h1 class="title">Org ad hoc code, quick hacks and workarounds</h1>


<p>
<a href="index.html">{Back to Worg's index}</a>
</p>
<p>
This page is for ad hoc bits of code. Feel free to add quick hacks and
workaround. Go crazy.
</p>

<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">Hacking Org: Working within Org-mode.</a>
<ul>
<li><a href="#sec-1-1">Building and Managing Org</a>
<ul>
<li><a href="#compiling-org-without-make">Compiling Org without make</a></li>
<li><a href="#sec-1-1-2">Reload Org</a></li>
<li><a href="#check-old-link-escapes">Check for possibly problematic old link escapes</a></li>
</ul>
</li>
<li><a href="#sec-1-2">Structure Movement and Editing</a>
<ul>
<li><a href="#sec-1-2-1">Show next/prev heading tidily</a></li>
<li><a href="#sec-1-2-2">Promote all items in subtree</a></li>
<li><a href="#heading-to-link">Turn a heading into an Org link</a></li>
<li><a href="#sec-1-2-4">Using M-up and M-down to transpose paragraphs</a></li>
<li><a href="#sec-1-2-5">Changelog support for org headers</a></li>
<li><a href="#sec-1-2-6">Different org-cycle-level behavior</a></li>
<li><a href="#sec-1-2-7">Count words in an Org buffer</a></li>
<li><a href="#sec-1-2-8">Check for misplaced SCHEDULED and DEADLINE cookies</a></li>
</ul>
</li>
<li><a href="#sec-1-3">Org Table</a>
<ul>
<li><a href="#transpose-table">Transpose table</a></li>
<li><a href="#sec-1-3-2">Manipulate hours/minutes/seconds in table formulas</a></li>
<li><a href="#sec-1-3-3">Dates computation</a></li>
<li><a href="#sec-1-3-4">Hex computation</a></li>
<li><a href="#field-coordinates-in-formulas">Field coordinates in formulas (<code>@#</code> and <code>$#</code>)</a></li>
<li><a href="#column-sequence-in-row">Change the column sequence in one row only</a></li>
</ul>
</li>
<li><a href="#sec-1-4">Capture and Remember</a>
<ul>
<li><a href="#sec-1-4-1">Customize the size of the frame for remember</a></li>
</ul>
</li>
<li><a href="#sec-1-5">Handling Links</a>
<ul>
<li><a href="#sec-1-5-1">Turn a heading into an org link</a></li>
<li><a href="#sec-1-5-2">Quickaccess to the link part of hyperlinks</a></li>
</ul>
</li>
<li><a href="#sec-1-6">Archiving Content in Org-Mode</a>
<ul>
<li><a href="#sec-1-6-1">Preserve top level headings when archiving to a file</a></li>
<li><a href="#sec-1-6-2">Archive in a date tree</a></li>
<li><a href="#sec-1-6-3">Add inherited tags to archived entries</a></li>
</ul>
</li>
<li><a href="#sec-1-7">Using and Managing Org-Metadata</a>
<ul>
<li><a href="#sec-1-7-1">Remove redundant tags of headlines</a></li>
<li><a href="#sec-1-7-2">Remove empty property drawers</a></li>
<li><a href="#sec-1-7-3">Group task list by a property</a></li>
<li><a href="#sec-1-7-4">A way to tag a task so that when clocking-out user is prompted to take a note.</a></li>
<li><a href="#sec-1-7-5">Dynamically adjust tag position</a></li>
<li><a href="#sec-1-7-6">Use an "attach" link type to open files without worrying about their location</a></li>
</ul>
</li>
<li><a href="#sec-1-8">Org Agenda and Task Management</a>
<ul>
<li><a href="#sec-1-8-1">Make it easier to set org-agenda-files from multiple directories</a></li>
<li><a href="#set-agenda-files-by-filetag">Restrict org-agenda-files by filetag</a></li>
<li><a href="#sec-1-8-3">Highlight the agenda line under cursor</a></li>
<li><a href="#sec-1-8-4">Split frame horizontally for agenda</a></li>
<li><a href="#sec-1-8-5">Automatically add an appointment when clocking in a task</a></li>
<li><a href="#sec-1-8-6">Using external programs for appointments reminders</a></li>
<li><a href="#sec-1-8-7">Remove from agenda time grid lines that are in an appointment</a></li>
<li><a href="#sec-1-8-8">Disable version control for Org mode agenda files</a></li>
<li><a href="#sec-1-8-9">Easy customization of TODO colors</a></li>
<li><a href="#sec-1-8-10">Add an effort estimate on the fly when clocking in</a></li>
<li><a href="#sec-1-8-11">Use idle timer for automatic agenda views</a></li>
<li><a href="#sec-1-8-12">Refresh the agenda view regularly</a></li>
<li><a href="#sec-1-8-13">Reschedule agenda items to today with a single command</a></li>
<li><a href="#sec-1-8-14">Mark subtree DONE along with all subheadings</a></li>
<li><a href="#mark-done-when-all-checkboxes-checked">Mark heading done when all checkboxes are checked.</a></li>
</ul>
</li>
<li><a href="#sec-1-9">Exporting org files</a>
<ul>
<li><a href="#sec-1-9-1">Export Org to Org and handle includes.</a></li>
<li><a href="#latex-command-for-floats">Specifying LaTeX commands to floating environments</a></li>
<li><a href="#sec-1-9-3">Styling code sections with CSS</a></li>
</ul></li>
</ul>
</li>
<li><a href="#sec-2">Hacking Org: Working with Org-mode and other Emacs Packages.</a>
<ul>
<li><a href="#sec-2-1">org-remember-anything</a></li>
<li><a href="#sec-2-2">Org-mode and saveplace.el</a></li>
<li><a href="#sec-2-3">Using ido-completing-read to find attachments</a></li>
<li><a href="#sec-2-4">Link to Gnus messages by Message-Id</a></li>
<li><a href="#sec-2-5">Store link to a message when sending in Gnus</a></li>
<li><a href="#sec-2-6">Send html messages and attachments with Wanderlust</a>
<ul>
<li><a href="#sec-2-6-1">Send HTML message</a></li>
<li><a href="#sec-2-6-2">Attach HTML of region or subtree</a></li>
<li><a href="#sec-2-6-3">Adopting for Gnus</a></li>
</ul>
</li>
<li><a href="#sec-2-7">Add sunrise/sunset times to the agenda.</a></li>
<li><a href="#sec-2-8">Export BBDB contacts to org-contacts.el</a></li>
<li><a href="#sec-2-9">Calculating date differences - how to write a simple elisp function</a></li>
</ul>
</li>
<li><a href="#sec-3">Hacking Org: Working with Org-mode and External Programs.</a>
<ul>
<li><a href="#sec-3-1">Use Org-mode with Screen [Andrew Hyatt]</a></li>
<li><a href="#org-agenda-appt-zenity">Org Agenda + Appt + Zenity</a></li>
<li><a href="#sec-3-3">Org-Mode + gnome-osd</a></li>
<li><a href="#sec-3-4">remind2org</a></li>
<li><a href="#sec-3-5">Useful webjumps for conkeror</a></li>
<li><a href="#sec-3-6">Use MathJax for HTML export without requiring JavaScript</a></li>
<li><a href="#sec-3-7">Search Org files using lgrep</a></li>
<li><a href="#sec-3-8">Automatic screenshot insertion</a></li>
<li><a href="#sec-3-9">Capture invitations/appointments from MS Exchange emails</a></li>
<li><a href="#sec-3-10">Audio/video file playback within org mode</a></li>
<li><a href="#sec-3-11">Under X11 Keep a window with the current agenda items at all time</a></li>
<li><a href="#sec-3-12">Script (thru procmail) to output emails to an Org file</a></li>
<li><a href="#fileconversion">Save File With Different Format for Headings (fileconversion)</a>
<ul>
<li><a href="#hidestarsfile">Headings Without Leading Stars (hidestarsfile and nbspstarsfile)</a></li>
<li><a href="#markdownstarsfile">Headings in Markdown Format (markdownstarsfile)</a></li>
<li><a href="#fileconversion-code">emacs-lisp code</a></li>
</ul>
</li>
<li><a href="#sec-3-14">Meaningful diff for org files in a git repository</a></li>
</ul>
</li>
<li><a href="#sec-4">Musings</a>
<ul>
<li><a href="#sec-4-1">Cooking?  Brewing?</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">Hacking Org: Working within Org-mode.</h2>
<div class="outline-text-2" id="text-1">


</div>

<div id="outline-container-1-1" class="outline-3">
<h3 id="sec-1-1">Building and Managing Org</h3>
<div class="outline-text-3" id="text-1-1">


</div>

<div id="outline-container-compiling-org-without-make" class="outline-4">
<h4 id="compiling-org-without-make"><a name="sec-1-1-1" id="sec-1-1-1"></a>Compiling Org without make</h4>
<div class="outline-text-4" id="text-compiling-org-without-make">



<p>
This file is the result of  <a href="http://article.gmane.org/gmane.emacs.orgmode/15264">one of our discussions</a> on the mailing list.
Enhancements welcome.
</p>
<p>
To use this function, adjust the variables <code>my/org-lisp-directory</code> and
<code>my/org-compile-sources</code> to suite your needs.
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">my/org-lisp-directory</span> <span style="color: #2aa198;">"~/.emacs.d/org/lisp"</span>
  <span style="color: #2aa198; font-style: italic;">"Directory where your org-mode files live."</span>)

(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">my/org-compile-sources</span> t
  <span style="color: #2aa198; font-style: italic;">"If `</span><span style="color: #268bd2; font-weight: bold; font-style: italic;">nil</span><span style="color: #2aa198; font-style: italic;">', never compile org-sources. `</span><span style="color: #268bd2; font-weight: bold; font-style: italic;">my/compile-org</span><span style="color: #2aa198; font-style: italic;">' will only create</span>
<span style="color: #2aa198; font-style: italic;">the autoloads file `</span><span style="color: #268bd2; font-weight: bold; font-style: italic;">org-install.el</span><span style="color: #2aa198; font-style: italic;">' then. If `t', compile the sources, too."</span>)

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Customize:</span>
(setq my/org-lisp-directory <span style="color: #2aa198;">"~/.emacs.d/org/lisp"</span>)

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Customize:</span>
(setq  my/org-compile-sources t)

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my/compile-org</span>(<span style="color: #b58900;">&amp;optional</span> directory)
  <span style="color: #2aa198; font-style: italic;">"Compile all *.el files that come with org-mode."</span>
  (interactive)
  (setq directory (concat
                     (file-truename
                    (or directory my/org-lisp-directory)) <span style="color: #2aa198;">"/"</span>))

  (add-to-list 'load-path directory)

  (<span style="color: #859900; font-weight: bold;">let</span> ((list-of-org-files (file-expand-wildcards (concat directory <span style="color: #2aa198;">"*.el"</span>))))

    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">create the org-install file</span>
    (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #268bd2; font-weight: bold;">autoload</span>)
    (setq esf/org-install-file (concat directory <span style="color: #2aa198;">"org-install.el"</span>))
    (find-file esf/org-install-file)
    (erase-buffer)
    (mapc (<span style="color: #859900; font-weight: bold;">lambda</span> (x)
            (generate-file-autoloads x))
          list-of-org-files)
    (insert <span style="color: #2aa198;">"\n(provide (quote org-install))\n"</span>)
    (save-buffer)
    (kill-buffer)
    (byte-compile-file esf/org-install-file t)

    (<span style="color: #859900; font-weight: bold;">dolist</span> (f list-of-org-files)
      (<span style="color: #859900; font-weight: bold;">if</span> (file-exists-p (concat f <span style="color: #2aa198;">"c"</span>)) <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">delete compiled files</span>
          (delete-file (concat f <span style="color: #2aa198;">"c"</span>)))
      (<span style="color: #859900; font-weight: bold;">if</span> my/org-compile-sources     <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">Compile, if `</span><span style="color: #268bd2; font-weight: bold;">my/org-compile-sources</span><span style="color: #93a1a1;">' is t</span>
          (byte-compile-file f)))))
</pre>

</div>

</div>

<div id="outline-container-1-1-2" class="outline-4">
<h4 id="sec-1-1-2">Reload Org</h4>
<div class="outline-text-4" id="text-1-1-2">



<p>
As of Org version 6.23b (released Sunday Feb 22, 2009) there is a new
function to reload org files.
</p>
<p>
Normally you want to use the compiled files since they are faster.
If you update your org files you can easily reload them with
</p>
<pre class="example">
M-x org-reload
</pre>


<p>
If you run into a bug and want to generate a useful backtrace you can
reload the source files instead of the compiled files with
</p>
<pre class="example">
C-u M-x org-reload
</pre>


<p>
and turn on the "Enter Debugger On Error" option.  Redo the action
that generates the error and cut and paste the resulting backtrace.
To switch back to the compiled version just reload again with
</p>
<pre class="example">
M-x org-reload
</pre>


</div>

</div>

<div id="outline-container-check-old-link-escapes" class="outline-4">
<h4 id="check-old-link-escapes"><a name="sec-1-1-3" id="sec-1-1-3"></a>Check for possibly problematic old link escapes</h4>
<div class="outline-text-4" id="text-check-old-link-escapes">

<p>Starting with version 7.5 Org uses <a href="http://en.wikipedia.org/wiki/Percent-encoding">percent escaping</a> more consistently
and with a modified algorithm to determine which characters to escape
and how.
</p>
<p>
As a side effect this modified behaviour might break existing links if
they contain a sequence of characters that look like a percent escape
(e.g. <code>[0-9A-Fa-f]{2}</code>) but are in fact not a percent escape.
</p>
<p>
The function below can be used to perform a preliminary check for such
links in an Org mode file.  It will run through all links in the file
and issue a warning if it finds a percent escape sequence which is not
in old Org's list of known percent escapes.
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">dmaus/org-check-percent-escapes</span> ()
  <span style="color: #2aa198; font-style: italic;">"*Check buffer for possibly problematic old link escapes."</span>
  (interactive)
  (<span style="color: #859900; font-weight: bold;">when</span> (eq major-mode 'org-mode)
    (<span style="color: #859900; font-weight: bold;">let</span> ((old-escapes '(<span style="color: #2aa198;">"%20"</span> <span style="color: #2aa198;">"%5B"</span> <span style="color: #2aa198;">"%5D"</span> <span style="color: #2aa198;">"%E0"</span> <span style="color: #2aa198;">"%E2"</span> <span style="color: #2aa198;">"%E7"</span> <span style="color: #2aa198;">"%E8"</span> <span style="color: #2aa198;">"%E9"</span>
                         <span style="color: #2aa198;">"%EA"</span> <span style="color: #2aa198;">"%EE"</span> <span style="color: #2aa198;">"%F4"</span> <span style="color: #2aa198;">"%F9"</span> <span style="color: #2aa198;">"%FB"</span> <span style="color: #2aa198;">"%3B"</span> <span style="color: #2aa198;">"%3D"</span> <span style="color: #2aa198;">"%2B"</span>)))
      (<span style="color: #859900; font-weight: bold;">unless</span> (boundp 'warning-suppress-types)
        (setq warning-suppress-types nil))
      (widen)
      (show-all)
      (goto-char (point-min))
      (<span style="color: #859900; font-weight: bold;">while</span> (re-search-forward org-any-link-re nil t)
        (<span style="color: #859900; font-weight: bold;">let</span> ((end (match-end 0)))
          (goto-char (match-beginning 0))
          (<span style="color: #859900; font-weight: bold;">while</span> (re-search-forward <span style="color: #2aa198;">"%[0-9a-zA-Z]\\{2\\}"</span> end t)
            (<span style="color: #859900; font-weight: bold;">let</span> ((escape (match-string-no-properties 0)))
              (<span style="color: #859900; font-weight: bold;">unless</span> (member (upcase escape) old-escapes)
                (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">warn</span> <span style="color: #2aa198;">"Found unknown percent escape sequence %s at buffer %s, position %d"</span>
                      escape
                      (buffer-name)
                      (- (point) 3)))))
          (goto-char end))))))
</pre>


</div>
</div>

</div>

<div id="outline-container-1-2" class="outline-3">
<h3 id="sec-1-2">Structure Movement and Editing</h3>
<div class="outline-text-3" id="text-1-2">


</div>

<div id="outline-container-1-2-1" class="outline-4">
<h4 id="sec-1-2-1">Show next/prev heading tidily</h4>
<div class="outline-text-4" id="text-1-2-1">


<ul>
<li>Dan Davison
  These close the current heading and open the next/previous heading.
</li>
</ul>





<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ded/org-show-next-heading-tidily</span> ()
  <span style="color: #2aa198; font-style: italic;">"Show next entry, keeping other entries closed."</span>
  (<span style="color: #859900; font-weight: bold;">if</span> (<span style="color: #859900; font-weight: bold;">save-excursion</span> (end-of-line) (outline-invisible-p))
      (<span style="color: #859900; font-weight: bold;">progn</span> (org-show-entry) (show-children))
    (outline-next-heading)
    (<span style="color: #859900; font-weight: bold;">unless</span> (and (bolp) (org-on-heading-p))
      (org-up-heading-safe)
      (hide-subtree)
      (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span> <span style="color: #2aa198;">"Boundary reached"</span>))
    (org-overview)
    (org-reveal t)
    (org-show-entry)
    (show-children)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ded/org-show-previous-heading-tidily</span> ()
  <span style="color: #2aa198; font-style: italic;">"Show previous entry, keeping other entries closed."</span>
  (<span style="color: #859900; font-weight: bold;">let</span> ((pos (point)))
    (outline-previous-heading)
    (<span style="color: #859900; font-weight: bold;">unless</span> (and (&lt; (point) pos) (bolp) (org-on-heading-p))
      (goto-char pos)
      (hide-subtree)
      (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span> <span style="color: #2aa198;">"Boundary reached"</span>))
    (org-overview)
    (org-reveal t)
    (org-show-entry)
    (show-children)))

(setq org-use-speed-commands t)
(add-to-list 'org-speed-commands-user
             '(<span style="color: #2aa198;">"n"</span> ded/org-show-next-heading-tidily))
(add-to-list 'org-speed-commands-user
             '(<span style="color: #2aa198;">"p"</span> ded/org-show-previous-heading-tidily))
</pre>


</div>

</div>

<div id="outline-container-1-2-2" class="outline-4">
<h4 id="sec-1-2-2">Promote all items in subtree</h4>
<div class="outline-text-4" id="text-1-2-2">

<ul>
<li>Matt Lundin
</li>
</ul>


<p>
This function will promote all items in a subtree. Since I use
subtrees primarily to organize projects, the function is somewhat
unimaginatively called my-org-un-project:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-un-project</span> ()
  (interactive)
  (org-map-entries 'org-do-promote <span style="color: #2aa198;">"LEVEL&gt;1"</span> 'tree)
  (org-cycle t))
</pre>


</div>

</div>

<div id="outline-container-heading-to-link" class="outline-4">
<h4 id="heading-to-link"><a name="sec-1-2-3" id="sec-1-2-3"></a>Turn a heading into an Org link</h4>
<div class="outline-text-4" id="text-heading-to-link">

<p>From David Maus:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">dmj:turn-headline-into-org-mode-link</span> ()
  <span style="color: #2aa198; font-style: italic;">"Replace word at point by an Org mode link."</span>
  (interactive)
  (<span style="color: #859900; font-weight: bold;">when</span> (org-at-heading-p)
    (<span style="color: #859900; font-weight: bold;">let</span> ((hl-text (nth 4 (org-heading-components))))
      (<span style="color: #859900; font-weight: bold;">unless</span> (or (null hl-text)
                  (org-string-match-p <span style="color: #2aa198;">"^[ \t]*:[</span><span style="color: #657b83;">^</span><span style="color: #2aa198;">:]+:$"</span> hl-text))
        (beginning-of-line)
        (search-forward hl-text (point-at-eol))
        (replace-string
         hl-text
         (format <span style="color: #2aa198;">"[[file:%s.org][%s]]"</span>
                 (org-link-escape hl-text)
                 (org-link-escape hl-text '((?\] . <span style="color: #2aa198;">"%5D"</span>) (?\[ . <span style="color: #2aa198;">"%5B"</span>))))
         nil (- (point) (length hl-text)) (point))))))
</pre>


</div>

</div>

<div id="outline-container-1-2-4" class="outline-4">
<h4 id="sec-1-2-4">Using M-up and M-down to transpose paragraphs</h4>
<div class="outline-text-4" id="text-1-2-4">


<p>
From Paul Sexton: By default, if used within ordinary paragraphs in
org mode, <code>M-up</code> and <code>M-down</code> transpose <b>lines</b> (not sentences).  The
following code makes these keys transpose paragraphs, keeping the
point at the start of the moved paragraph. Behavior in tables and
headings is unaffected. It would be easy to modify this to transpose
sentences.
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-transpose-paragraphs</span> (arg)
 (interactive)
 (<span style="color: #859900; font-weight: bold;">when</span> (and (not (or (org-at-table-p) (org-on-heading-p) (org-at-item-p)))
            (thing-at-point 'sentence))
   (transpose-paragraphs arg)
   (backward-paragraph)
   (re-search-forward <span style="color: #2aa198;">"[[:graph:]]"</span>)
   (goto-char (match-beginning 0))
   t))

(add-to-list 'org-metaup-hook 
 (<span style="color: #859900; font-weight: bold;">lambda</span> () (interactive) (org-transpose-paragraphs -1)))
(add-to-list 'org-metadown-hook 
 (<span style="color: #859900; font-weight: bold;">lambda</span> () (interactive) (org-transpose-paragraphs 1)))
</pre>

</div>

</div>

<div id="outline-container-1-2-5" class="outline-4">
<h4 id="sec-1-2-5">Changelog support for org headers</h4>
<div class="outline-text-4" id="text-1-2-5">

<p>&ndash; James TD Smith
</p>
<p>
Put the following in your <code>.emacs</code>, and <code>C-x 4 a</code> and other functions which
use <code>add-log-current-defun</code> like <code>magit-add-log</code> will pick up the nearest org
headline as the "current function" if you add a changelog entry from an org
buffer.
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-log-current-defun</span> ()
  (<span style="color: #859900; font-weight: bold;">save-excursion</span>
    (org-back-to-heading)
    (<span style="color: #859900; font-weight: bold;">if</span> (looking-at org-complex-heading-regexp)
        (match-string 4))))

(add-hook 'org-mode-hook
          (<span style="color: #859900; font-weight: bold;">lambda</span> ()
            (make-variable-buffer-local 'add-log-current-defun-function)
            (setq add-log-current-defun-function 'org-log-current-defun)))
</pre>


</div>

</div>

<div id="outline-container-1-2-6" class="outline-4">
<h4 id="sec-1-2-6">Different org-cycle-level behavior</h4>
<div class="outline-text-4" id="text-1-2-6">

<p>&ndash; Ryan Thompson
</p>
<p>
In recent org versions, when your point (cursor) is at the end of an
empty header line (like after you first created the header), the TAB
key (<code>org-cycle</code>) has a special behavior: it cycles the headline through
all possible levels. However, I did not like the way it determined
"all possible levels," so I rewrote the whole function, along with a
couple of supporting functions.
</p>
<p>
The original function's definition of "all possible levels" was "every
level from 1 to one more than the initial level of the current
headline before you started cycling." My new definition is "every
level from 1 to one more than the previous headline's level." So, if
you have a headline at level 4 and you use ALT+RET to make a new
headline below it, it will cycle between levels 1 and 5, inclusive.
</p>
<p>
The main advantage of my custom <code>org-cycle-level</code> function is that it
is stateless: the next level in the cycle is determined entirely by
the contents of the buffer, and not what command you executed last.
This makes it more predictable, I hope.
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #268bd2; font-weight: bold;">cl</span>)

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-point-at-end-of-empty-headline</span> ()
  <span style="color: #2aa198; font-style: italic;">"If point is at the end of an empty headline, return t, else nil."</span>
  (and (looking-at <span style="color: #2aa198;">"[ \t]*$"</span>)
       (<span style="color: #859900; font-weight: bold;">save-excursion</span>
         (beginning-of-line 1)
         (looking-at (concat <span style="color: #2aa198;">"^</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">\\*+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">[ \t]+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">"</span> org-todo-regexp <span style="color: #2aa198;">"</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">?[ \t]*"</span>)))))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-level-increment</span> ()
  <span style="color: #2aa198; font-style: italic;">"Return the number of stars that will be added or removed at a</span>
<span style="color: #2aa198; font-style: italic;">time to headlines when structure editing, based on the value of</span>
<span style="color: #2aa198; font-style: italic;">`</span><span style="color: #268bd2; font-weight: bold; font-style: italic;">org-odd-levels-only</span><span style="color: #2aa198; font-style: italic;">'."</span>
  (<span style="color: #859900; font-weight: bold;">if</span> org-odd-levels-only 2 1))

(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">org-previous-line-level-cached</span> nil)

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-recalculate-previous-line-level</span> ()
  <span style="color: #2aa198; font-style: italic;">"Same as `</span><span style="color: #268bd2; font-weight: bold; font-style: italic;">org-get-previous-line-level</span><span style="color: #2aa198; font-style: italic;">', but does not use cached</span>
<span style="color: #2aa198; font-style: italic;">value. It does *set* the cached value, though."</span>
  (set 'org-previous-line-level-cached
       (<span style="color: #859900; font-weight: bold;">let</span> ((current-level (org-current-level))
             (prev-level (<span style="color: #859900; font-weight: bold;">when</span> (&gt; (line-number-at-pos) 1)
                           (<span style="color: #859900; font-weight: bold;">save-excursion</span>
                             (previous-line)
                             (org-current-level)))))
         (<span style="color: #859900; font-weight: bold;">cond</span> ((null current-level) nil) <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">Before first headline</span>
               ((null prev-level) 0)      <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">At first headline</span>
               (prev-level)))))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-get-previous-line-level</span> ()
  <span style="color: #2aa198; font-style: italic;">"Return the outline depth of the last headline before the</span>
<span style="color: #2aa198; font-style: italic;">current line. Returns 0 for the first headline in the buffer, and</span>
<span style="color: #2aa198; font-style: italic;">nil if before the first headline."</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">This calculation is quite expensive, with all the regex searching</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">and stuff. Since org-cycle-level won't change lines, we can reuse</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">the last value of this command.</span>
  (or (and (eq last-command 'org-cycle-level)
           org-previous-line-level-cached)
      (org-recalculate-previous-line-level)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-cycle-level</span> ()
  (interactive)
  (<span style="color: #859900; font-weight: bold;">let</span> ((org-adapt-indentation nil))
    (<span style="color: #859900; font-weight: bold;">when</span> (org-point-at-end-of-empty-headline)
      (setq this-command 'org-cycle-level) <span style="color: #93a1a1;">;</span><span style="color: #93a1a1;">Only needed for caching</span>
      (<span style="color: #859900; font-weight: bold;">let</span> ((cur-level (org-current-level))
            (prev-level (org-get-previous-line-level)))
        (<span style="color: #859900; font-weight: bold;">cond</span>
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">If first headline in file, promote to top-level.</span>
         ((= prev-level 0)
          (<span style="color: #859900; font-weight: bold;">loop</span> repeat (/ (- cur-level 1) (org-level-increment))
                do (org-do-promote)))
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">If same level as prev, demote one.</span>
         ((= prev-level cur-level)
          (org-do-demote))
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">If parent is top-level, promote to top level if not already.</span>
         ((= prev-level 1)
          (<span style="color: #859900; font-weight: bold;">loop</span> repeat (/ (- cur-level 1) (org-level-increment))
                do (org-do-promote)))
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">If top-level, return to prev-level.</span>
         ((= cur-level 1)
          (<span style="color: #859900; font-weight: bold;">loop</span> repeat (/ (- prev-level 1) (org-level-increment))
                do (org-do-demote)))
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">If less than prev-level, promote one.</span>
         ((&lt; cur-level prev-level)
          (org-do-promote))
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">If deeper than prev-level, promote until higher than</span>
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">prev-level.</span>
         ((&gt; cur-level prev-level)
          (<span style="color: #859900; font-weight: bold;">loop</span> repeat (+ 1 (/ (- cur-level prev-level) (org-level-increment)))
                do (org-do-promote))))
        t))))
</pre>


</div>

</div>

<div id="outline-container-1-2-7" class="outline-4">
<h4 id="sec-1-2-7">Count words in an Org buffer</h4>
<div class="outline-text-4" id="text-1-2-7">

<p>Paul Sexton <a href="http://article.gmane.org/gmane.emacs.orgmode/38014">posted</a> this function to count words in an Org buffer:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-word-count</span> (beg end
                           <span style="color: #b58900;">&amp;optional</span> count-latex-macro-args?
                           count-footnotes?)
  <span style="color: #2aa198; font-style: italic;">"Report the number of words in the Org mode buffer or selected region.</span>
<span style="color: #2aa198; font-style: italic;">Ignores:</span>
<span style="color: #2aa198; font-style: italic;">- comments</span>
<span style="color: #2aa198; font-style: italic;">- tables</span>
<span style="color: #2aa198; font-style: italic;">- source code blocks (#+BEGIN_SRC ... #+END_SRC, and inline blocks)</span>
<span style="color: #2aa198; font-style: italic;">- hyperlinks (but does count words in hyperlink descriptions)</span>
<span style="color: #2aa198; font-style: italic;">- tags, priorities, and TODO keywords in headers</span>
<span style="color: #2aa198; font-style: italic;">- sections tagged as 'not for export'.</span>

<span style="color: #2aa198; font-style: italic;">The text of footnote definitions is ignored, unless the optional argument</span>
<span style="color: #2aa198; font-style: italic;">COUNT-FOOTNOTES? is non-nil.</span>

<span style="color: #2aa198; font-style: italic;">If the optional argument COUNT-LATEX-MACRO-ARGS? is non-nil, the word count</span>
<span style="color: #2aa198; font-style: italic;">includes LaTeX macro arguments (the material between {curly braces}).</span>
<span style="color: #2aa198; font-style: italic;">Otherwise, and by default, every LaTeX macro counts as 1 word regardless</span>
<span style="color: #2aa198; font-style: italic;">of its arguments."</span>
  (interactive <span style="color: #2aa198;">"r"</span>)
  (<span style="color: #859900; font-weight: bold;">unless</span> mark-active
    (setf beg (point-min)
     end (point-max)))
  (<span style="color: #859900; font-weight: bold;">let</span> ((wc 0)
   (latex-macro-regexp <span style="color: #2aa198;">"\\\\[</span><span style="color: #268bd2; font-weight: bold;">A-Za-z</span><span style="color: #2aa198;">]+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">\\[[</span><span style="color: #657b83;">^</span><span style="color: #2aa198;">]]*\\]</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">|</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">{</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[</span><span style="color: #657b83;">^</span><span style="color: #2aa198;">}]*</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">}"</span>))
    (<span style="color: #859900; font-weight: bold;">save-excursion</span>
      (goto-char beg)
      (<span style="color: #859900; font-weight: bold;">while</span> (&lt; (point) end)
        (<span style="color: #859900; font-weight: bold;">cond</span>
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Ignore comments.</span>
         ((or (org-in-commented-line) (org-at-table-p))
          nil)
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Ignore hyperlinks. But if link has a description, count</span>
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">the words within the description.</span>
         ((looking-at org-bracket-link-analytic-regexp)
          (<span style="color: #859900; font-weight: bold;">when</span> (match-string-no-properties 5)
            (<span style="color: #859900; font-weight: bold;">let</span> ((desc (match-string-no-properties 5)))
              (<span style="color: #859900; font-weight: bold;">save-match-data</span>
                (incf wc (length (remove <span style="color: #2aa198;">""</span> (org-split-string
                                             desc <span style="color: #2aa198;">"\\W"</span>)))))))
          (goto-char (match-end 0)))
         ((looking-at org-any-link-re)
          (goto-char (match-end 0)))
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Ignore source code blocks.</span>
         ((org-in-regexps-block-p <span style="color: #2aa198;">"^#\\+BEGIN_SRC\\W"</span> <span style="color: #2aa198;">"^#\\+END_SRC\\W"</span>)
          nil)
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Ignore inline source blocks, counting them as 1 word.</span>
         ((<span style="color: #859900; font-weight: bold;">save-excursion</span>
            (backward-char)
            (looking-at org-babel-inline-src-block-regexp))
          (goto-char (match-end 0))
          (setf wc (+ 2 wc)))
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Count latex macros as 1 word, ignoring their arguments.</span>
         ((<span style="color: #859900; font-weight: bold;">save-excursion</span>
            (backward-char)
            (looking-at latex-macro-regexp))
          (goto-char (<span style="color: #859900; font-weight: bold;">if</span> count-latex-macro-args?
                         (match-beginning 2)
                       (match-end 0)))
          (setf wc (+ 2 wc)))
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Ignore footnotes.</span>
         ((and (not count-footnotes?)
               (or (org-footnote-at-definition-p)
                   (org-footnote-at-reference-p)))
          nil)
         (t
          (<span style="color: #859900; font-weight: bold;">let</span> ((contexts (org-context)))
            (<span style="color: #859900; font-weight: bold;">cond</span>
             <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Ignore tags and TODO keywords, etc.</span>
             ((or (assoc <span style="color: #268bd2; font-style: italic;">:todo-keyword</span> contexts)
                  (assoc <span style="color: #268bd2; font-style: italic;">:priority</span> contexts)
                  (assoc <span style="color: #268bd2; font-style: italic;">:keyword</span> contexts)
                  (assoc <span style="color: #268bd2; font-style: italic;">:checkbox</span> contexts))
              nil)
             <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Ignore sections marked with tags that are</span>
             <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">excluded from export.</span>
             ((assoc <span style="color: #268bd2; font-style: italic;">:tags</span> contexts)
              (<span style="color: #859900; font-weight: bold;">if</span> (intersection (org-get-tags-at) org-export-exclude-tags
                                <span style="color: #268bd2; font-style: italic;">:test</span> 'equal)
                  (org-forward-same-level 1)
                nil))
             (t
              (incf wc))))))
        (re-search-forward <span style="color: #2aa198;">"\\w+\\W*"</span>)))
    (message (format <span style="color: #2aa198;">"%d words in %s."</span> wc
                     (<span style="color: #859900; font-weight: bold;">if</span> mark-active <span style="color: #2aa198;">"region"</span> <span style="color: #2aa198;">"buffer"</span>)))))
</pre>


</div>

</div>

<div id="outline-container-1-2-8" class="outline-4">
<h4 id="sec-1-2-8">Check for misplaced SCHEDULED and DEADLINE cookies</h4>
<div class="outline-text-4" id="text-1-2-8">


<p>
The <code>SCHEDULED</code> and <code>DEADLINE</code> cookies should be used on the line <b>right below</b> the headline &ndash; like this:
</p>



<pre class="src src-org"><span style="color: #cb4b16; background-color: #fdf6e3;">* A headline</span>
  <span style="color: #93a1a1; font-weight: bold;">SCHEDULED:</span> <span style="color: #268bd2; text-decoration: underline;">&lt;2012-04-09 lun.&gt;</span>
</pre>


<p>
This is what <code>org-scheduled</code> and <code>org-deadline</code> (and other similar
commands) do.  And the manual explicitely tell people to stick to this
format (see the section "8.3.1 Inserting deadlines or schedules").
</p>
<p>
If you think you might have subtrees with misplaced <code>SCHEDULED</code> and
<code>DEADLINE</code> cookies, this command lets you check the current buffer:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-check-misformatted-subtree</span> ()
  <span style="color: #2aa198; font-style: italic;">"Check misformatted entries in the current buffer."</span>
  (interactive)
  (show-all)
  (org-map-entries
   (<span style="color: #859900; font-weight: bold;">lambda</span> ()
     (<span style="color: #859900; font-weight: bold;">when</span> (and (move-beginning-of-line 2)
      (not (looking-at org-heading-regexp)))
       (<span style="color: #859900; font-weight: bold;">if</span> (or (and (org-get-scheduled-time (point))
          (not (looking-at (concat <span style="color: #2aa198;">"^.*"</span> org-scheduled-regexp))))
          (and (org-get-deadline-time (point))
          (not (looking-at (concat <span style="color: #2aa198;">"^.*"</span> org-deadline-regexp)))))
      (<span style="color: #859900; font-weight: bold;">when</span> (y-or-n-p <span style="color: #2aa198;">"Fix this subtree? "</span>)
        (message <span style="color: #2aa198;">"Call the function again when you're done fixing this subtree."</span>)
        (recursive-edit))
    (message <span style="color: #2aa198;">"All subtrees checked."</span>))))))
</pre>


</div>
</div>

</div>

<div id="outline-container-1-3" class="outline-3">
<h3 id="sec-1-3">Org Table</h3>
<div class="outline-text-3" id="text-1-3">


</div>

<div id="outline-container-transpose-table" class="outline-4">
<h4 id="transpose-table"><a name="sec-1-3-1" id="sec-1-3-1"></a>Transpose table</h4>
<div class="outline-text-4" id="text-transpose-table">


<p>
Since Org 7.8, you can use <code>org-table-transpose-table-at-point</code> (which
see.)  There are also other solutions:
</p>
<ul>
<li>with org-babel and Emacs Lisp: provided by Thomas S. Dye in the mailing
  list, see <a href="http://thread.gmane.org/gmane.emacs.orgmode/23809/focus=23815">gmane</a> or <a href="http://lists.gnu.org/archive/html/emacs-orgmode/2010-04/msg00239.html">gnu</a>

</li>
<li>with org-babel and R: provided by Dan Davison in the mailing list (old
  <code>#+TBLR:</code> syntax), see <a href="http://thread.gmane.org/gmane.emacs.orgmode/10159/focus=10159">gmane</a> or <a href="http://lists.gnu.org/archive/html/emacs-orgmode/2008-12/msg00454.html">gnu</a>

</li>
<li>with field coordinates in formulas (<code>@#</code> and <code>$#</code>): see <a href="org-hacks.html#field-coordinates-in-formulas-transpose-table">Worg</a>.
</li>
</ul>


</div>

</div>

<div id="outline-container-1-3-2" class="outline-4">
<h4 id="sec-1-3-2">Manipulate hours/minutes/seconds in table formulas</h4>
<div class="outline-text-4" id="text-1-3-2">

<p>Both Bastien and Martin Halder have posted code (<a href="http://article.gmane.org/gmane.emacs.orgmode/39519">Bastien's code</a> and
<a href="http://article.gmane.org/gmane.emacs.orgmode/39519">Martin's code</a>) for interpreting <code>dd:dd</code> or <code>dd:dd:dd</code> strings (where
"<code>d</code>" is any digit) as time values in Org-mode table formula.  These
functions have now been wrapped up into a <code>with-time</code> macro which can
be used in table formula to translate table cell values to and from
numerical values for algebraic manipulation.
</p>
<p>
Here is the code implementing this macro.
</p>


<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-time-string-to-seconds</span> (s)
  <span style="color: #2aa198; font-style: italic;">"Convert a string HH:MM:SS to a number of seconds."</span>
  (<span style="color: #859900; font-weight: bold;">cond</span>
   ((and (stringp s)
         (string-match <span style="color: #2aa198;">"</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[0-9]+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">:</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[0-9]+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">:</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[0-9]+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">"</span> s))
    (<span style="color: #859900; font-weight: bold;">let</span> ((hour (string-to-number (match-string 1 s)))
          (min (string-to-number (match-string 2 s)))
          (sec (string-to-number (match-string 3 s))))
      (+ (* hour 3600) (* min 60) sec)))
   ((and (stringp s)
         (string-match <span style="color: #2aa198;">"</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[0-9]+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">:</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[0-9]+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">"</span> s))
    (<span style="color: #859900; font-weight: bold;">let</span> ((min (string-to-number (match-string 1 s)))
          (sec (string-to-number (match-string 2 s))))
      (+ (* min 60) sec)))
   ((stringp s) (string-to-number s))
   (t s)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-time-seconds-to-string</span> (secs)
  <span style="color: #2aa198; font-style: italic;">"Convert a number of seconds to a time string."</span>
  (<span style="color: #859900; font-weight: bold;">cond</span> ((&gt;= secs 3600) (format-seconds <span style="color: #2aa198;">"%h:%.2m:%.2s"</span> secs))
        ((&gt;= secs 60) (format-seconds <span style="color: #2aa198;">"%m:%.2s"</span> secs))
        (t (format-seconds <span style="color: #2aa198;">"%s"</span> secs))))

(<span style="color: #859900; font-weight: bold;">defmacro</span> <span style="color: #268bd2;">with-time</span> (time-output-p <span style="color: #b58900;">&amp;rest</span> exprs)
  <span style="color: #2aa198; font-style: italic;">"Evaluate an org-table formula, converting all fields that look</span>
<span style="color: #2aa198; font-style: italic;">like time data to integer seconds.  If TIME-OUTPUT-P then return</span>
<span style="color: #2aa198; font-style: italic;">the result as a time value."</span>
  (list
   (<span style="color: #859900; font-weight: bold;">if</span> time-output-p 'org-time-seconds-to-string 'identity)
   (cons 'progn
         (mapcar
          (<span style="color: #859900; font-weight: bold;">lambda</span> (expr)
            `,(cons (car expr)
                    (mapcar
                     (<span style="color: #859900; font-weight: bold;">lambda</span> (el)
                       (<span style="color: #859900; font-weight: bold;">if</span> (listp el)
                           (list 'with-time nil el)
                         (org-time-string-to-seconds el)))
                     (cdr expr))))
          `,@exprs))))
</pre>


<p>
Which allows the following forms of table manipulation such as adding
and subtracting time values.
</p><pre class="example">
| Date             | Start | Lunch |  Back |   End |  Sum |
|------------------+-------+-------+-------+-------+------|
| [2011-03-01 Tue] |  8:00 | 12:00 | 12:30 | 18:15 | 9:45 |
#+TBLFM: $6='(with-time t (+ (- $5 $4) (- $3 $2)))
</pre>


<p>
and dividing time values by integers
</p><pre class="example">
|  time | miles | minutes/mile |
|-------+-------+--------------|
| 34:43 |   2.9 |        11:58 |
| 32:15 |  2.77 |        11:38 |
| 33:56 |   3.0 |        11:18 |
| 52:22 |  4.62 |        11:20 |
#+TBLFM: $3='(with-time t (/ $1 $2))
</pre>


<p>
<b>Update</b>: As of Org version 7.6, you can use the <code>T</code> flag (both in Calc and
Elisp formulas) to compute time durations.  For example:
</p>
<pre class="example">
| Task 1 | Task 2 |   Total |
|--------+--------+---------|
|  35:00 |  35:00 | 1:10:00 |
#+TBLFM: @2$3=$1+$2;T
</pre>


</div>

</div>

<div id="outline-container-1-3-3" class="outline-4">
<h4 id="sec-1-3-3">Dates computation</h4>
<div class="outline-text-4" id="text-1-3-3">

<p>Xin Shi <a href="http://article.gmane.org/gmane.emacs.orgmode/15692">asked</a> for a way to calculate the duration of 
dates stored in an org table.
</p>
<p>
Nick Dokos <a href="http://article.gmane.org/gmane.emacs.orgmode/15694">suggested</a>:
</p>
<p>
Try the following:
</p>
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption></caption>
<colgroup><col class="left" /><col class="left" /><col class="left" />
</colgroup>
<thead>
<tr><th scope="col" class="left">Start Date</th><th scope="col" class="left">End Date</th><th scope="col" class="left">Duration</th></tr>
</thead>
<tbody>
<tr><td class="left">2004.08.07</td><td class="left">2005.07.08</td><td class="left">335</td></tr>
</tbody>
</table>

:#+TBLFM: $3=(date(&lt;$2&gt;)-date(&lt;$1&gt;))

<p>
See <a href="http://thread.gmane.org/gmane.emacs.orgmode/7741">this thread</a> as well as <a href="http://article.gmane.org/gmane.emacs.orgmode/7753">this post</a> (which is really a followup on the
above).  The problem that this last article pointed out was solved in <a href="http://article.gmane.org/gmane.emacs.orgmode/8001">this post</a> and Chris Randle's original musings are <a href="http://article.gmane.org/gmane.emacs.orgmode/6536/">here</a>.
</p>
</div>

</div>

<div id="outline-container-1-3-4" class="outline-4">
<h4 id="sec-1-3-4">Hex computation</h4>
<div class="outline-text-4" id="text-1-3-4">

<p>As with Times computation, the following code allows Computation with
Hex values in Org-mode tables using the <code>with-hex</code> macro.
</p>
<p>
Here is the code implementing this macro.
</p>


<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-hex-strip-lead</span> (str)
  (<span style="color: #859900; font-weight: bold;">if</span> (and (&gt; (length str) 2) (string= (substring str 0 2) <span style="color: #2aa198;">"0x"</span>))
      (substring str 2) str))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-hex-to-hex</span> (int)
  (format <span style="color: #2aa198;">"0x%x"</span> int))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-hex-to-dec</span> (str)
  (<span style="color: #859900; font-weight: bold;">cond</span>
   ((and (stringp str)
         (string-match <span style="color: #2aa198;">"</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[0-9a-f]+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">"</span> (setf str (org-hex-strip-lead str))))
    (<span style="color: #859900; font-weight: bold;">let</span> ((out 0))
      (mapc
       (<span style="color: #859900; font-weight: bold;">lambda</span> (ch)
         (setf out (+ (* out 16)
                      (<span style="color: #859900; font-weight: bold;">if</span> (and (&gt;= ch 48) (&lt;= ch 57)) (- ch 48) (- ch 87)))))
       (coerce (match-string 1 str) 'list))
      out))
   ((stringp str) (string-to-number str))
   (t str)))

(<span style="color: #859900; font-weight: bold;">defmacro</span> <span style="color: #268bd2;">with-hex</span> (hex-output-p <span style="color: #b58900;">&amp;rest</span> exprs)
  <span style="color: #2aa198; font-style: italic;">"Evaluate an org-table formula, converting all fields that look</span>
<span style="color: #2aa198; font-style: italic;">    like hexadecimal to decimal integers.  If HEX-OUTPUT-P then</span>
<span style="color: #2aa198; font-style: italic;">    return the result as a hex value."</span>
  (list
   (<span style="color: #859900; font-weight: bold;">if</span> hex-output-p 'org-hex-to-hex 'identity)
   (cons 'progn
         (mapcar
          (<span style="color: #859900; font-weight: bold;">lambda</span> (expr)
            `,(cons (car expr)
                    (mapcar (<span style="color: #859900; font-weight: bold;">lambda</span> (el)
                              (<span style="color: #859900; font-weight: bold;">if</span> (listp el)
                                  (list 'with-hex nil el)
                                (org-hex-to-dec el)))
                            (cdr expr))))
          `,@exprs))))
</pre>


<p>
Which allows the following forms of table manipulation such as adding
and subtracting hex values.
</p><table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">
<caption></caption>
<colgroup><col class="right" /><col class="right" /><col class="right" /><col class="right" />
</colgroup>
<tbody>
<tr><td class="right">0x10</td><td class="right">0x0</td><td class="right">0x10</td><td class="right">16</td></tr>
<tr><td class="right">0x20</td><td class="right">0x1</td><td class="right">0x21</td><td class="right">33</td></tr>
<tr><td class="right">0x30</td><td class="right">0x2</td><td class="right">0x32</td><td class="right">50</td></tr>
<tr><td class="right">0xf0</td><td class="right">0xf</td><td class="right">0xff</td><td class="right">255</td></tr>
</tbody>
</table>


</div>

</div>

<div id="outline-container-field-coordinates-in-formulas" class="outline-4">
<h4 id="field-coordinates-in-formulas"><a name="sec-1-3-5" id="sec-1-3-5"></a>Field coordinates in formulas (<code>@#</code> and <code>$#</code>)</h4>
<div class="outline-text-4" id="text-field-coordinates-in-formulas">

<p>&ndash; Michael Brand
</p>
<p>
Following are some use cases that can be implemented with the “field
coordinates in formulas” described in the corresponding chapter in the
<a href="http://orgmode.org/manual/References.html#References">Org manual</a>.
</p>
<ul>
<li id="field-coordinates-in-formulas-copy-col-to-col"><a name="sec-1-3-5-1" id="sec-1-3-5-1"></a>Copy a column from a remote table into a column<br/>

<p>
current column <code>$3</code> = remote column <code>$2</code>:
</p><pre class="example">
#+TBLFM: $3 = remote(FOO, @@#$2)
</pre>


</li>
</ul>
<ul>
<li id="field-coordinates-in-formulas-copy-row-to-col"><a name="sec-1-3-5-2" id="sec-1-3-5-2"></a>Copy a row from a remote table transposed into a column<br/>

<p>
current column <code>$1</code> = transposed remote row <code>@1</code>:
</p><pre class="example">
#+TBLFM: $1 = remote(FOO, @$#$@#)
</pre>


</li>
</ul>
<ul>
<li id="field-coordinates-in-formulas-transpose-table"><a name="sec-1-3-5-3" id="sec-1-3-5-3"></a>Transpose table<br/>

<p>
&ndash; Michael Brand
</p>
<p>
This is more like a demonstration of using “field coordinates in formulas”
and is bound to be slow for large tables. See the discussion in the mailing
list on
<a href="http://thread.gmane.org/gmane.emacs.orgmode/22610/focus=23662">gmane</a> or
<a href="http://lists.gnu.org/archive/html/emacs-orgmode/2010-04/msg00086.html">gnu</a>.
For more efficient solutions see
<a href="org-hacks.html#transpose-table">Worg</a>.
</p>
<p>
To transpose this 4x7 table
</p>
<pre class="example">
#+TBLNAME: FOO
| year | 2004 | 2005 | 2006 | 2007 | 2008 | 2009 |
|------+------+------+------+------+------+------|
| min  |  401 |  501 |  601 |  701 |  801 |  901 |
| avg  |  402 |  502 |  602 |  702 |  802 |  902 |
| max  |  403 |  503 |  603 |  703 |  803 |  903 |
</pre>


<p>
start with a 7x4 table without any horizontal line (to have filled
also the column header) and yet empty:
</p>
<pre class="example">
|   |   |   |   |
|   |   |   |   |
|   |   |   |   |
|   |   |   |   |
|   |   |   |   |
|   |   |   |   |
|   |   |   |   |
</pre>


<p>
Then add the <code>TBLFM</code> line below.  After recalculation this will end up with
the transposed copy:
</p>
<pre class="example">
| year | min | avg | max |
| 2004 | 401 | 402 | 403 |
| 2005 | 501 | 502 | 503 |
| 2006 | 601 | 602 | 603 |
| 2007 | 701 | 702 | 703 |
| 2008 | 801 | 802 | 803 |
| 2009 | 901 | 902 | 903 |
#+TBLFM: @&lt;$&lt;..@&gt;$&gt; = remote(FOO, @$#$@#)
</pre>


<p>
The formula simply exchanges row and column numbers by taking
</p><ul>
<li>the absolute remote row number <code>@$#</code> from the current column number <code>$#</code>
</li>
<li>the absolute remote column number <code>$@#</code> from the current row number <code>@#</code>
</li>
</ul>


<p>
Formulas to be taken over from the remote table will have to be transformed
manually.
</p>
</li>
</ul>
<ul>
<li id="sec-1-3-5-4">Dynamic variation of ranges<br/>

<p>
&ndash; Michael Brand
</p>
<p>
In this example all columns next to <code>quote</code> are calculated from the column
<code>quote</code> and show the average change of the time series <code>quote[year]</code>
during the period of the preceding <code>1</code>, <code>2</code>, <code>3</code> or <code>4</code> years:
</p>
<pre class="example">
| year | quote |   1 a |   2 a |   3 a |   4 a |
|------+-------+-------+-------+-------+-------|
| 2005 |    10 |       |       |       |       |
| 2006 |    12 | 0.200 |       |       |       |
| 2007 |    14 | 0.167 | 0.183 |       |       |
| 2008 |    16 | 0.143 | 0.155 | 0.170 |       |
| 2009 |    18 | 0.125 | 0.134 | 0.145 | 0.158 |
#+TBLFM: @I$3..@&gt;$&gt;=if(@# &gt;= $#, ($2 / subscr(@-I$2..@+I$2, @# + 1 - $#)) ^ (1 / ($# - 2)) - 1, string("")) +.0; f-3
</pre>


<p>
The important part of the formula without the field blanking is:
</p>
<pre class="example">
($2 / subscr(@-I$2..@+I$2, @# + 1 - $#)) ^ (1 / ($# - 2)) - 1
</pre>


<p>
which is the Emacs Calc implementation of the equation
</p>
<p>
<i>AvgChange(i, a) = (quote[i] / quote[i - a]) ^ (1 / a) - 1</i>
</p>
<p>
where <i>i</i> is the current time and <i>a</i> is the length of the preceding period.
</p>
</li>
</ul>
</div>

</div>

<div id="outline-container-column-sequence-in-row" class="outline-4">
<h4 id="column-sequence-in-row"><a name="sec-1-3-6" id="sec-1-3-6"></a>Change the column sequence in one row only</h4>
<div class="outline-text-4" id="text-column-sequence-in-row">


<p>
&ndash; Michael Brand
</p>
<p>
The functions below can be used to change the column sequence in one row
only, without affecting the other rows above and below like with M-&lt;left&gt; or
M-&lt;right&gt; (org-table-move-column). Please see the docstring of the functions
for more explanations. Below is one example per function, with this original
table as the starting point for each example:
</p><pre class="example">
| a | b | c  | d  |
| e | 9 | 10 | 11 |
| f | g | h  | i  |
</pre>


<ul>
<li id="sec-1-3-6-1">Move in row left<br/>

<ol>
<li>place point at "10" in original table
</li>
<li>result of M-x my-org-table-move-column-in-row-left:
<pre class="example">
| a | b  | c | d  |
| e | 10 | 9 | 11 |
| f | g  | h | i  |
</pre>

</li>
</ol>


</li>
</ul>
<ul>
<li id="sec-1-3-6-2">Move in row right<br/>

<ol>
<li>place point at "9" in original table
</li>
<li>result of M-x my-org-table-move-column-in-row-right:
<pre class="example">
| a | b  | c | d  |
| e | 10 | 9 | 11 |
| f | g  | h | i  |
</pre>

</li>
</ol>


</li>
</ul>
<ul>
<li id="sec-1-3-6-3">Rotate in row left<br/>

<ol>
<li>place point at "9" in original table
</li>
<li>result of M-x my-org-table-rotate-column-in-row-left:
<pre class="example">
| a | b  | c  | d |
| e | 10 | 11 | 9 |
| f | g  | h  | i |
</pre>

</li>
</ol>


</li>
</ul>
<ul>
<li id="sec-1-3-6-4">Rotate in row right<br/>

<ol>
<li>place point at "9" in original table
</li>
<li>result of M-x my-org-table-rotate-column-in-row-right:
<pre class="example">
| a | b  | c | d  |
| e | 11 | 9 | 10 |
| f | g  | h | i  |
</pre>

</li>
</ol>


</li>
</ul>
<ul>
<li id="sec-1-3-6-5">The functions<br/>




<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-table-move-column-in-row-right</span> ()
  <span style="color: #2aa198; font-style: italic;">"Move column to the right, limited to the current row."</span>
  (interactive)
  (my-org-table-move-column-in-row nil))
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-table-move-column-in-row-left</span> ()
  <span style="color: #2aa198; font-style: italic;">"Move column to the left, limited to the current row."</span>
  (interactive)
  (my-org-table-move-column-in-row 'left))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-table-move-column-in-row</span> (<span style="color: #b58900;">&amp;optional</span> left)
  <span style="color: #2aa198; font-style: italic;">"Move the current column to the right, limited to the current row.</span>
<span style="color: #2aa198; font-style: italic;">With arg LEFT, move to the left.  For repeated invocation the point follows</span>
<span style="color: #2aa198; font-style: italic;">the value and changes to the target colum.  Does not fix formulas."</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">derived from `</span><span style="color: #268bd2; font-weight: bold;">org-table-move-column</span><span style="color: #93a1a1;">'</span>
  (interactive <span style="color: #2aa198;">"P"</span>)
  (<span style="color: #859900; font-weight: bold;">if</span> (not (org-at-table-p))
      (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span> <span style="color: #2aa198;">"Not at a table"</span>))
  (org-table-find-dataline)
  (org-table-check-inside-data-field)
  (<span style="color: #859900; font-weight: bold;">let*</span> ((col (org-table-current-column))
         (col1 (<span style="color: #859900; font-weight: bold;">if</span> left (1- col) col))
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Current cursor position</span>
         (colpos (<span style="color: #859900; font-weight: bold;">if</span> left (1- col) (1+ col))))
    (<span style="color: #859900; font-weight: bold;">if</span> (and left (= col 1))
        (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span> <span style="color: #2aa198;">"Cannot move column further left"</span>))
    (<span style="color: #859900; font-weight: bold;">if</span> (and (not left) (looking-at <span style="color: #2aa198;">"[</span><span style="color: #657b83;">^</span><span style="color: #2aa198;">|\n]*|[</span><span style="color: #657b83;">^</span><span style="color: #2aa198;">|\n]*$"</span>))
        (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span> <span style="color: #2aa198;">"Cannot move column further right"</span>))
    (org-table-goto-column col1 t)
    (and (looking-at <span style="color: #2aa198;">"|</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[</span><span style="color: #657b83;">^</span><span style="color: #2aa198;">|\n]+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">|</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[</span><span style="color: #657b83;">^</span><span style="color: #2aa198;">|\n]+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">|"</span>)
         (replace-match <span style="color: #2aa198;">"|\\2|\\1|"</span>))
    (org-table-goto-column colpos)
    (org-table-align)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-table-rotate-column-in-row-right</span> ()
  <span style="color: #2aa198; font-style: italic;">"Rotate column to the right, limited to the current row."</span>
  (interactive)
  (my-org-table-rotate-column-in-row nil))
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-table-rotate-column-in-row-left</span> ()
  <span style="color: #2aa198; font-style: italic;">"Rotate column to the left, limited to the current row."</span>
  (interactive)
  (my-org-table-rotate-column-in-row 'left))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-table-rotate-column-in-row</span> (<span style="color: #b58900;">&amp;optional</span> left)
  <span style="color: #2aa198; font-style: italic;">"Rotate the current column to the right, limited to the current row.</span>
<span style="color: #2aa198; font-style: italic;">With arg LEFT, rotate to the left.  The boundaries of the rotation range are</span>
<span style="color: #2aa198; font-style: italic;">the current and the most right column for both directions.  For repeated</span>
<span style="color: #2aa198; font-style: italic;">invocation the point stays on the current column.  Does not fix formulas."</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">derived from `</span><span style="color: #268bd2; font-weight: bold;">org-table-move-column</span><span style="color: #93a1a1;">'</span>
  (interactive <span style="color: #2aa198;">"P"</span>)
  (<span style="color: #859900; font-weight: bold;">if</span> (not (org-at-table-p))
      (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span> <span style="color: #2aa198;">"Not at a table"</span>))
  (org-table-find-dataline)
  (org-table-check-inside-data-field)
  (<span style="color: #859900; font-weight: bold;">let</span> ((col (org-table-current-column)))
    (org-table-goto-column col t)
    (and (looking-at (<span style="color: #859900; font-weight: bold;">if</span> left
                         <span style="color: #2aa198;">"|</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[</span><span style="color: #657b83;">^</span><span style="color: #2aa198;">|\n]+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">|</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[</span><span style="color: #657b83;">^</span><span style="color: #2aa198;">\n]+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">|$"</span>
                       <span style="color: #2aa198;">"|</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[</span><span style="color: #657b83;">^</span><span style="color: #2aa198;">\n]+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">|</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[</span><span style="color: #657b83;">^</span><span style="color: #2aa198;">|\n]+</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">|$"</span>))
         (replace-match <span style="color: #2aa198;">"|\\2|\\1|"</span>))
    (org-table-goto-column col)
    (org-table-align)))
</pre>


</li>
</ul>
<ul>
<li id="sec-1-3-6-6">Key bindings<br/>

<p>
As hack I have this in an Org buffer to change temporarily to the desired
behavior with C-c C-c on one of the three snippets:
</p><pre class="example">
- move in row:
  #+begin_src emacs-lisp :results silent
    (org-defkey org-mode-map [(meta left)]
                'my-org-table-move-column-in-row-left)
    (org-defkey org-mode-map [(meta right)]
                'my-org-table-move-column-in-row-right)
    (org-defkey org-mode-map [(left)]  'org-table-previous-field)
    (org-defkey org-mode-map [(right)] 'org-table-next-field)
  #+end_src

- rotate in row:
  #+begin_src emacs-lisp :results silent
    (org-defkey org-mode-map [(meta left)]
                'my-org-table-rotate-column-in-row-left)
    (org-defkey org-mode-map [(meta right)]
                'my-org-table-rotate-column-in-row-right)
    (org-defkey org-mode-map [(left)]  'org-table-previous-field)
    (org-defkey org-mode-map [(right)] 'org-table-next-field)
  #+end_src

- back to original:
  #+begin_src emacs-lisp :results silent
    (org-defkey org-mode-map [(meta left)]  'org-metaleft)
    (org-defkey org-mode-map [(meta right)] 'org-metaright)
    (org-defkey org-mode-map [(left)]  'backward-char)
    (org-defkey org-mode-map [(right)] 'forward-char)
  #+end_src
</pre>


</li>
</ul>
<ul>
<li id="sec-1-3-6-7">reasons why this is not put into the Org core<br/>

<p>
I consider this as only a hack for several reasons:
</p><ul>
<li>Generalization:  The existing org-table-move-column function could be
  enhanced with additional optional parameters to incorporate these
  functionalities and could be used as the only function for better
  maintainability.  Now it's only a copy/paste hack of several similar
  functions with simple modifications.
</li>
<li>Bindings:  Should be convenient for repetition like M-&lt;right&gt;.  What
  should be bound where, what has to be left unbound?
</li>
<li>Does not fix formulas.  Could be resolved for field formulas but
  most probably not for column or range formulas and this can lead
  to confusion.  AFAIK all "official" table manipulations fix formulas.
</li>
<li>Completeness:  Not all variations and combinations are covered yet
<ul>
<li>left-right, up-down
</li>
<li>move, rotate with range to end, rotate with range to begin
</li>
<li>whole column/row, only in-row/in-column
</li>
</ul>

</li>
</ul>


</li>
</ul>
</div>
</div>

</div>

<div id="outline-container-1-4" class="outline-3">
<h3 id="sec-1-4">Capture and Remember</h3>
<div class="outline-text-3" id="text-1-4">


</div>

<div id="outline-container-1-4-1" class="outline-4">
<h4 id="sec-1-4-1">Customize the size of the frame for remember</h4>
<div class="outline-text-4" id="text-1-4-1">

<p>(Note: this hack is likely out of date due to the development of
<a href="#org-capture">org-capture</a>.)
</p>
<p>
On emacs-orgmode, Ryan C. Thompson suggested this:
</p>
<blockquote>

<p>I am using org-remember set to open a new frame when used,
and the default frame size is much too large. To fix this, I have
designed some advice and a custom variable to implement custom
parameters for the remember frame:
</p>
</blockquote>





<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defcustom</span> <span style="color: #268bd2;">remember-frame-alist</span> nil
  <span style="color: #2aa198; font-style: italic;">"Additional frame parameters for dedicated remember frame."</span>
  <span style="color: #268bd2; font-style: italic;">:type</span> 'alist
  <span style="color: #268bd2; font-style: italic;">:group</span> 'remember)

(<span style="color: #859900; font-weight: bold;">defadvice</span> <span style="color: #268bd2;">remember</span> (around remember-frame-parameters activate)
  <span style="color: #2aa198; font-style: italic;">"Set some frame parameters for the remember frame."</span>
  (<span style="color: #859900; font-weight: bold;">let</span> ((default-frame-alist (append remember-frame-alist
                                     default-frame-alist)))
    ad-do-it))
</pre>


<p>
Setting remember-frame-alist to <code>((width . 80) (height . 15)))</code> give a
reasonable size for the frame.
</p></div>
</div>

</div>

<div id="outline-container-1-5" class="outline-3">
<h3 id="sec-1-5">Handling Links</h3>
<div class="outline-text-3" id="text-1-5">


</div>

<div id="outline-container-1-5-1" class="outline-4">
<h4 id="sec-1-5-1"><a href="#heading-to-link">Turn a heading into an org link</a></h4>
<div class="outline-text-4" id="text-1-5-1">

</div>

</div>

<div id="outline-container-1-5-2" class="outline-4">
<h4 id="sec-1-5-2">Quickaccess to the link part of hyperlinks</h4>
<div class="outline-text-4" id="text-1-5-2">

<p>Christian Moe <a href="http://permalink.gmane.org/gmane.emacs.orgmode/43122">asked</a>, if there is a simpler way to copy the link part
of an org hyperling other than to use `C-c C-l C-a C-k C-g', 
which is indeed kind of cumbersome.
</p>
<p>
The thread offered <a href="http://permalink.gmane.org/gmane.emacs.orgmode/43606">two ways</a>:
</p>
<p>
Using a <a href="http://www.gnu.org/software/emacs/manual/html_node/emacs/Keyboard-Macros.html">keyboard macro</a>:
</p>


<pre class="src src-emacs-lisp">(fset 'getlink
      (<span style="color: #859900; font-weight: bold;">lambda</span> (<span style="color: #b58900;">&amp;optional</span> arg) 
        <span style="color: #2aa198; font-style: italic;">"Keyboard macro."</span> 
        (interactive <span style="color: #2aa198;">"p"</span>) 
        (kmacro-exec-ring-item (quote (<span style="color: #2aa198;">"\C-c\C-l\C-a\C-k\C-g"</span> 0 <span style="color: #2aa198;">"%d"</span>)) arg)))
</pre>


<p>
or a function: 
</p>


<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-extract-link</span> ()
  <span style="color: #2aa198; font-style: italic;">"Extract the link location at point and put it on the killring."</span>
  (interactive)
  (<span style="color: #859900; font-weight: bold;">when</span> (org-in-regexp org-bracket-link-regexp 1)
    (kill-new (org-link-unescape (org-match-string-no-properties 1)))))
</pre>


<p>
They put the link destination on the killring and can be easily bound to a key.
</p>
</div>
</div>

</div>

<div id="outline-container-1-6" class="outline-3">
<h3 id="sec-1-6">Archiving Content in Org-Mode</h3>
<div class="outline-text-3" id="text-1-6">


</div>

<div id="outline-container-1-6-1" class="outline-4">
<h4 id="sec-1-6-1">Preserve top level headings when archiving to a file</h4>
<div class="outline-text-4" id="text-1-6-1">

<ul>
<li>Matt Lundin
</li>
</ul>


<p>
To preserve (somewhat) the integrity of your archive structure while
archiving lower level items to a file, you can use the following
defadvice:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defadvice</span> <span style="color: #268bd2;">org-archive-subtree</span> (around my-org-archive-subtree activate)
  (<span style="color: #859900; font-weight: bold;">let</span> ((org-archive-location
         (<span style="color: #859900; font-weight: bold;">if</span> (<span style="color: #859900; font-weight: bold;">save-excursion</span> (org-back-to-heading)
                             (&gt; (org-outline-level) 1))
             (concat (car (split-string org-archive-location <span style="color: #2aa198;">"::"</span>))
                     <span style="color: #2aa198;">"::* "</span>
                     (car (org-get-outline-path)))
           org-archive-location)))
    ad-do-it))
</pre>


<p>
Thus, if you have an outline structure such as&hellip;
</p>



<pre class="src src-org"><span style="color: #cb4b16; background-color: #fdf6e3;">* Heading</span>
<span style="color: #859900; background-color: #fdf6e3;">** Subheading</span>
<span style="color: #268bd2; background-color: #fdf6e3;">*** Subsubheading</span>
</pre>


<p>
&hellip;archiving "Subsubheading" to a new file will set the location in
the new file to the top level heading:
</p>



<pre class="src src-org"><span style="color: #cb4b16; background-color: #fdf6e3;">* Heading</span>
<span style="color: #859900; background-color: #fdf6e3;">** Subsubheading</span>
</pre>


<p>
While this hack obviously destroys the outline hierarchy somewhat, it
at least preserves the logic of level one groupings.
</p>
<p>
A slightly more complex version of this hack will not only keep the
archive organized by top-level headings, but will also preserve the
tags found on those headings:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-inherited-no-file-tags</span> ()
  (<span style="color: #859900; font-weight: bold;">let</span> ((tags (org-entry-get nil <span style="color: #2aa198;">"ALLTAGS"</span> 'selective))
        (ltags (org-entry-get nil <span style="color: #2aa198;">"TAGS"</span>)))
    (mapc (<span style="color: #859900; font-weight: bold;">lambda</span> (tag)
            (setq tags
                  (replace-regexp-in-string (concat tag <span style="color: #2aa198;">":"</span>) <span style="color: #2aa198;">""</span> tags)))
          (append org-file-tags (<span style="color: #859900; font-weight: bold;">when</span> ltags (split-string ltags <span style="color: #2aa198;">":"</span> t))))
    (<span style="color: #859900; font-weight: bold;">if</span> (string= <span style="color: #2aa198;">":"</span> tags) nil tags)))

(<span style="color: #859900; font-weight: bold;">defadvice</span> <span style="color: #268bd2;">org-archive-subtree</span> (around my-org-archive-subtree-low-level activate)
  (<span style="color: #859900; font-weight: bold;">let</span> ((tags (my-org-inherited-no-file-tags))
        (org-archive-location
         (<span style="color: #859900; font-weight: bold;">if</span> (<span style="color: #859900; font-weight: bold;">save-excursion</span> (org-back-to-heading)
                             (&gt; (org-outline-level) 1))
             (concat (car (split-string org-archive-location <span style="color: #2aa198;">"::"</span>))
                     <span style="color: #2aa198;">"::* "</span>
                     (car (org-get-outline-path)))
           org-archive-location)))
    ad-do-it
    (<span style="color: #859900; font-weight: bold;">with-current-buffer</span> (find-file-noselect (org-extract-archive-file))
      (<span style="color: #859900; font-weight: bold;">save-excursion</span>
        (<span style="color: #859900; font-weight: bold;">while</span> (org-up-heading-safe))
        (org-set-tags-to tags)))))
</pre>


</div>

</div>

<div id="outline-container-1-6-2" class="outline-4">
<h4 id="sec-1-6-2">Archive in a date tree</h4>
<div class="outline-text-4" id="text-1-6-2">

<p>Posted to Org-mode mailing list by Osamu Okano <span class="timestamp-wrapper"> <span class="timestamp">2010-04-21 Wed</span></span>.
</p>
<p>
(Make sure org-datetree.el is loaded for this to work.)
</p>



<pre class="src src-emacs-lisp"><span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">(setq org-archive-location "%s_archive::date-tree")</span>
(<span style="color: #859900; font-weight: bold;">defadvice</span> <span style="color: #268bd2;">org-archive-subtree</span>
  (around org-archive-subtree-to-data-tree activate)
  <span style="color: #2aa198; font-style: italic;">"org-archive-subtree to date-tree"</span>
  (<span style="color: #859900; font-weight: bold;">if</span>
      (string= <span style="color: #2aa198;">"date-tree"</span>
               (org-extract-archive-heading
                (org-get-local-archive-location)))
      (<span style="color: #859900; font-weight: bold;">let*</span> ((dct (decode-time (org-current-time)))
             (y (nth 5 dct))
             (m (nth 4 dct))
             (d (nth 3 dct))
             (this-buffer (current-buffer))
             (location (org-get-local-archive-location))
             (afile (org-extract-archive-file location))
             (org-archive-location
              (format <span style="color: #2aa198;">"%s::*** %04d-%02d-%02d %s"</span> afile y m d
                      (format-time-string <span style="color: #2aa198;">"%A"</span> (encode-time 0 0 0 d m y)))))
        (message <span style="color: #2aa198;">"afile=%s"</span> afile)
        (<span style="color: #859900; font-weight: bold;">unless</span> afile
          (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span> <span style="color: #2aa198;">"Invalid `</span><span style="color: #268bd2; font-weight: bold;">org-archive-location</span><span style="color: #2aa198;">'"</span>))
        (<span style="color: #859900; font-weight: bold;">save-excursion</span>
          (switch-to-buffer (find-file-noselect afile))
          (org-datetree-find-year-create y)
          (org-datetree-find-month-create y m)
          (org-datetree-find-day-create y m d)
          (widen)
          (switch-to-buffer this-buffer))
        ad-do-it)
    ad-do-it))
</pre>


</div>

</div>

<div id="outline-container-1-6-3" class="outline-4">
<h4 id="sec-1-6-3">Add inherited tags to archived entries</h4>
<div class="outline-text-4" id="text-1-6-3">

<p>To make <code>org-archive-subtree</code> keep inherited tags, Osamu OKANO suggests to
advise the function like this:
</p>



<pre class="example">(defadvice org-archive-subtree
  (before add-inherited-tags-before-org-archive-subtree activate)
    "add inherited tags before org-archive-subtree"
    (org-set-tags-to (org-get-tags-at)))
</pre>


</div>
</div>

</div>

<div id="outline-container-1-7" class="outline-3">
<h3 id="sec-1-7">Using and Managing Org-Metadata</h3>
<div class="outline-text-3" id="text-1-7">


</div>

<div id="outline-container-1-7-1" class="outline-4">
<h4 id="sec-1-7-1">Remove redundant tags of headlines</h4>
<div class="outline-text-4" id="text-1-7-1">

<p>&ndash; David Maus
</p>
<p>
A small function that processes all headlines in current buffer and
removes tags that are local to a headline and inherited by a parent
headline or the #+FILETAGS: statement.
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">dmj/org-remove-redundant-tags</span> ()
  <span style="color: #2aa198; font-style: italic;">"Remove redundant tags of headlines in current buffer.</span>

<span style="color: #2aa198; font-style: italic;">A tag is considered redundant if it is local to a headline and</span>
<span style="color: #2aa198; font-style: italic;">inherited by a parent headline."</span>
  (interactive)
  (<span style="color: #859900; font-weight: bold;">when</span> (eq major-mode 'org-mode)
    (<span style="color: #859900; font-weight: bold;">save-excursion</span>
      (org-map-entries
       '(<span style="color: #859900; font-weight: bold;">lambda</span> ()
          (<span style="color: #859900; font-weight: bold;">let</span> ((alltags (split-string (or (org-entry-get (point) <span style="color: #2aa198;">"ALLTAGS"</span>) <span style="color: #2aa198;">""</span>) <span style="color: #2aa198;">":"</span>))
                local inherited tag)
            (<span style="color: #859900; font-weight: bold;">dolist</span> (tag alltags)
              (<span style="color: #859900; font-weight: bold;">if</span> (get-text-property 0 'inherited tag)
                  (push tag inherited) (push tag local)))
            (<span style="color: #859900; font-weight: bold;">dolist</span> (tag local)
              (<span style="color: #859900; font-weight: bold;">if</span> (member tag inherited) (org-toggle-tag tag 'off)))))
       t nil))))
</pre>


</div>

</div>

<div id="outline-container-1-7-2" class="outline-4">
<h4 id="sec-1-7-2">Remove empty property drawers</h4>
<div class="outline-text-4" id="text-1-7-2">

<p>David Maus proposed this:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">dmj:org:remove-empty-propert-drawers</span> ()
  <span style="color: #2aa198; font-style: italic;">"*Remove all empty property drawers in current file."</span>
  (interactive)
  (<span style="color: #859900; font-weight: bold;">unless</span> (eq major-mode 'org-mode)
    (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span> <span style="color: #2aa198;">"You need to turn on Org mode for this function."</span>))
  (<span style="color: #859900; font-weight: bold;">save-excursion</span>
    (goto-char (point-min))
    (<span style="color: #859900; font-weight: bold;">while</span> (re-search-forward <span style="color: #2aa198;">":PROPERTIES:"</span> nil t)
      (<span style="color: #859900; font-weight: bold;">save-excursion</span>
   (org-remove-empty-drawer-at <span style="color: #2aa198;">"PROPERTIES"</span> (match-beginning 0))))))
</pre>


</div>

</div>

<div id="outline-container-1-7-3" class="outline-4">
<h4 id="sec-1-7-3">Group task list by a property</h4>
<div class="outline-text-4" id="text-1-7-3">

<p>This advice allows you to group a task list in Org-Mode.  To use it,
set the variable <code>org-agenda-group-by-property</code> to the name of a
property in the option list for a TODO or TAGS search.  The resulting
agenda view will group tasks by that property prior to searching.
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">org-agenda-group-by-property</span> nil
  <span style="color: #2aa198; font-style: italic;">"Set this in org-mode agenda views to group tasks by property"</span>)

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-group-bucket-items</span> (prop items)
  (<span style="color: #859900; font-weight: bold;">let</span> ((buckets ()))
    (<span style="color: #859900; font-weight: bold;">dolist</span> (item items)
      (<span style="color: #859900; font-weight: bold;">let*</span> ((marker (get-text-property 0 'org-marker item))
             (pvalue (org-entry-get marker prop t))
             (cell (assoc pvalue buckets)))
        (<span style="color: #859900; font-weight: bold;">if</span> cell
            (setcdr cell (cons item (cdr cell)))
          (setq buckets (cons (cons pvalue (list item))
                              buckets)))))
    (setq buckets (mapcar (<span style="color: #859900; font-weight: bold;">lambda</span> (bucket)
                            (cons (car bucket)
                                  (reverse (cdr bucket))))
                          buckets))
    (sort buckets (<span style="color: #859900; font-weight: bold;">lambda</span> (i1 i2)
                    (string&lt; (car i1) (car i2))))))

(<span style="color: #859900; font-weight: bold;">defadvice</span> <span style="color: #268bd2;">org-finalize-agenda-entries</span> (around org-group-agenda-finalize
                                               (list <span style="color: #b58900;">&amp;optional</span> nosort))
  <span style="color: #2aa198; font-style: italic;">"Prepare bucketed agenda entry lists"</span>
  (<span style="color: #859900; font-weight: bold;">if</span> org-agenda-group-by-property
      <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">bucketed, handle appropriately</span>
      (<span style="color: #859900; font-weight: bold;">let</span> ((text <span style="color: #2aa198;">""</span>))
        (<span style="color: #859900; font-weight: bold;">dolist</span> (bucket (org-group-bucket-items
                         org-agenda-group-by-property
                         list))
          (<span style="color: #859900; font-weight: bold;">let</span> ((header (concat <span style="color: #2aa198;">"Property "</span>
                                org-agenda-group-by-property
                                <span style="color: #2aa198;">" is "</span>
                                (or (car bucket) <span style="color: #2aa198;">"&lt;nil&gt;"</span>) <span style="color: #2aa198;">":\n"</span>)))
            (add-text-properties 0 (1- (length header))
                                 (list 'face 'org-agenda-structure)
                                 header)
            (setq text
                  (concat text header
                          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">recursively process</span>
                          (<span style="color: #859900; font-weight: bold;">let</span> ((org-agenda-group-by-property nil))
                            (org-finalize-agenda-entries
                             (cdr bucket) nosort))
                          <span style="color: #2aa198;">"\n\n"</span>))))
        (setq ad-return-value text))
    ad-do-it))
(ad-activate 'org-finalize-agenda-entries)
</pre>

</div>

</div>

<div id="outline-container-1-7-4" class="outline-4">
<h4 id="sec-1-7-4">A way to tag a task so that when clocking-out user is prompted to take a note.</h4>
<div class="outline-text-4" id="text-1-7-4">

<p>    Thanks to Richard Riley (see <a href="http://permalink.gmane.org/gmane.emacs.orgmode/40896">this post on the mailing list</a>).
</p>
<p>
A small hook run when clocking out of a task that prompts for a note
when the tag "<code>clockout_note</code>" is found in a headline. It uses the tag
("<code>clockout_note</code>") so inheritance can also be used&hellip;
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">rgr/check-for-clock-out-note</span>()
      (interactive)
      (<span style="color: #859900; font-weight: bold;">save-excursion</span>
        (org-back-to-heading)
        (<span style="color: #859900; font-weight: bold;">let</span> ((tags (org-get-tags)))
          (and tags (message <span style="color: #2aa198;">"tags: %s "</span> tags)
               (<span style="color: #859900; font-weight: bold;">when</span> (member <span style="color: #2aa198;">"clocknote"</span> tags)
                 (org-add-note))))))

(add-hook 'org-clock-out-hook 'rgr/check-for-clock-out-note)
</pre>

</div>

</div>

<div id="outline-container-1-7-5" class="outline-4">
<h4 id="sec-1-7-5">Dynamically adjust tag position</h4>
<div class="outline-text-4" id="text-1-7-5">

<p>Here is a bit of code that allows you to have the tags always
right-adjusted in the buffer.
</p>
<p>
This is useful when you have bigger window than default window-size
and you dislike the aesthetics of having the tag in the middle of the
line.
</p>
<p>
This hack solves the problem of adjusting it whenever you change the
window size.
Before saving it will revert the file to having the tag position be
left-adjusted so that if you track your files with version control,
you won't run into artificial diffs just because the window-size
changed.
</p>
<p>
<b>IMPORTANT</b>: This is probably slow on very big files.
</p>



<pre class="src src-emacs-lisp">(setq ba/org-adjust-tags-column t)

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ba/org-adjust-tags-column-reset-tags</span> ()
  <span style="color: #2aa198; font-style: italic;">"In org-mode buffers it will reset tag position according to</span>
<span style="color: #2aa198; font-style: italic;">`</span><span style="color: #268bd2; font-weight: bold; font-style: italic;">org-tags-column</span><span style="color: #2aa198; font-style: italic;">'."</span>
  (<span style="color: #859900; font-weight: bold;">when</span> (and
         (not (string= (buffer-name) <span style="color: #2aa198;">"*Remember*"</span>))
         (eql major-mode 'org-mode))
    (<span style="color: #859900; font-weight: bold;">let</span> ((b-m-p (buffer-modified-p)))
      (<span style="color: #859900; font-weight: bold;">condition-case</span> nil
          (<span style="color: #859900; font-weight: bold;">save-excursion</span>
            (goto-char (point-min))
            (command-execute 'outline-next-visible-heading)
            <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">disable (message) that org-set-tags generates</span>
            (<span style="color: #859900; font-weight: bold;">flet</span> ((message (<span style="color: #b58900;">&amp;rest</span> ignored) nil))
              (org-set-tags 1 t))
            (set-buffer-modified-p b-m-p))
        (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span> nil)))))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ba/org-adjust-tags-column-now</span> ()
  <span style="color: #2aa198; font-style: italic;">"Right-adjust `</span><span style="color: #268bd2; font-weight: bold; font-style: italic;">org-tags-column</span><span style="color: #2aa198; font-style: italic;">' value, then reset tag position."</span>
  (set (make-local-variable 'org-tags-column)
       (- (- (window-width) (length org-ellipsis))))
  (ba/org-adjust-tags-column-reset-tags))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ba/org-adjust-tags-column-maybe</span> ()
  <span style="color: #2aa198; font-style: italic;">"If `</span><span style="color: #268bd2; font-weight: bold; font-style: italic;">ba/org-adjust-tags-column</span><span style="color: #2aa198; font-style: italic;">' is set to non-nil, adjust tags."</span>
  (<span style="color: #859900; font-weight: bold;">when</span> ba/org-adjust-tags-column
    (ba/org-adjust-tags-column-now)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ba/org-adjust-tags-column-before-save</span> ()
  <span style="color: #2aa198; font-style: italic;">"Tags need to be left-adjusted when saving."</span>
  (<span style="color: #859900; font-weight: bold;">when</span> ba/org-adjust-tags-column
     (setq org-tags-column 1)
     (ba/org-adjust-tags-column-reset-tags)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ba/org-adjust-tags-column-after-save</span> ()
  <span style="color: #2aa198; font-style: italic;">"Revert left-adjusted tag position done by before-save hook."</span>
  (ba/org-adjust-tags-column-maybe)
  (set-buffer-modified-p nil))

<span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">automatically align tags on right-hand side</span>
(add-hook 'window-configuration-change-hook
          'ba/org-adjust-tags-column-maybe)
(add-hook 'before-save-hook 'ba/org-adjust-tags-column-before-save)
(add-hook 'after-save-hook 'ba/org-adjust-tags-column-after-save)
(add-hook 'org-agenda-mode-hook '(<span style="color: #859900; font-weight: bold;">lambda</span> ()
                                  (setq org-agenda-tags-column (- (window-width)))))

<span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">between invoking org-refile and displaying the prompt (which</span>
<span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">triggers window-configuration-change-hook) tags might adjust,</span>
<span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">which invalidates the org-refile cache</span>
(<span style="color: #859900; font-weight: bold;">defadvice</span> <span style="color: #268bd2;">org-refile</span> (around org-refile-disable-adjust-tags)
  <span style="color: #2aa198; font-style: italic;">"Disable dynamically adjusting tags"</span>
  (<span style="color: #859900; font-weight: bold;">let</span> ((ba/org-adjust-tags-column nil))
    ad-do-it))
(ad-activate 'org-refile)
</pre>

</div>

</div>

<div id="outline-container-1-7-6" class="outline-4">
<h4 id="sec-1-7-6">Use an "attach" link type to open files without worrying about their location</h4>
<div class="outline-text-4" id="text-1-7-6">

<p>&ndash; Darlan Cavalcante Moreira
</p>
<p>
In the setup part in my org-files I put:
</p>



<pre class="src src-org"><span style="color: #93a1a1;">#+LINK: attach elisp:(org-open-file (org-attach-expand "%s"))</span>
</pre>


<p>
Now I can use the "attach" link type, but org will ask me if I want to
allow executing the elisp code.  To avoid this you can even set
org-confirm-elisp-link-function to nil (I don't like this because it allows
any elisp code in links) or you can set org-confirm-elisp-link-not-regexp
appropriately.
</p>
<p>
In my case I use
</p>
<pre class="example">
(setq org-confirm-elisp-link-not-regexp "org-open-file")
</pre>


<p>
This works very well.
</p>
</div>
</div>

</div>

<div id="outline-container-1-8" class="outline-3">
<h3 id="sec-1-8">Org Agenda and Task Management</h3>
<div class="outline-text-3" id="text-1-8">


</div>

<div id="outline-container-1-8-1" class="outline-4">
<h4 id="sec-1-8-1">Make it easier to set org-agenda-files from multiple directories</h4>
<div class="outline-text-4" id="text-1-8-1">

<ul>
<li>Matt Lundin
</li>
</ul>





<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-list-files</span> (dirs ext)
  <span style="color: #2aa198; font-style: italic;">"Function to create list of org files in multiple subdirectories.</span>
<span style="color: #2aa198; font-style: italic;">This can be called to generate a list of files for</span>
<span style="color: #2aa198; font-style: italic;">org-agenda-files or org-refile-targets.</span>

<span style="color: #2aa198; font-style: italic;">DIRS is a list of directories.</span>

<span style="color: #2aa198; font-style: italic;">EXT is a list of the extensions of files to be included."</span>
  (<span style="color: #859900; font-weight: bold;">let</span> ((dirs (<span style="color: #859900; font-weight: bold;">if</span> (listp dirs)
                  dirs
                (list dirs)))
        (ext (<span style="color: #859900; font-weight: bold;">if</span> (listp ext)
                 ext
               (list ext)))
        files)
    (mapc
     (<span style="color: #859900; font-weight: bold;">lambda</span> (x)
       (mapc
        (<span style="color: #859900; font-weight: bold;">lambda</span> (y)
          (setq files
                (append files
                        (file-expand-wildcards
                         (concat (file-name-as-directory x) <span style="color: #2aa198;">"*"</span> y)))))
        ext))
     dirs)
    (mapc
     (<span style="color: #859900; font-weight: bold;">lambda</span> (x)
       (<span style="color: #859900; font-weight: bold;">when</span> (or (string-match <span style="color: #2aa198;">"/.#"</span> x)
                 (string-match <span style="color: #2aa198;">"#$"</span> x))
         (setq files (delete x files))))
     files)
    files))

(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">my-org-agenda-directories</span> '(<span style="color: #2aa198;">"~/org/"</span>)
  <span style="color: #2aa198; font-style: italic;">"List of directories containing org files."</span>)
(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">my-org-agenda-extensions</span> '(<span style="color: #2aa198;">".org"</span>)
  <span style="color: #2aa198; font-style: italic;">"List of extensions of agenda files"</span>)

(setq my-org-agenda-directories '(<span style="color: #2aa198;">"~/org/"</span> <span style="color: #2aa198;">"~/work/"</span>))
(setq my-org-agenda-extensions '(<span style="color: #2aa198;">".org"</span> <span style="color: #2aa198;">".ref"</span>))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-set-agenda-files</span> ()
  (interactive)
  (setq org-agenda-files (my-org-list-files
                          my-org-agenda-directories
                          my-org-agenda-extensions)))

(my-org-set-agenda-files)
</pre>


<p>
The code above will set your "default" agenda files to all files
ending in ".org" and ".ref" in the directories "~/org/" and "~/work/".
You can change these values by setting the variables
my-org-agenda-extensions and my-org-agenda-directories. The function
my-org-agenda-files-by-filetag uses these two variables to determine
which files to search for filetags (i.e., the larger set from which
the subset will be drawn).
</p>
<p>
You can also easily use my-org-list-files to "mix and match"
directories and extensions to generate different lists of agenda
files.
</p>
</div>

</div>

<div id="outline-container-set-agenda-files-by-filetag" class="outline-4">
<h4 id="set-agenda-files-by-filetag"><a name="sec-1-8-2" id="sec-1-8-2"></a>Restrict org-agenda-files by filetag</h4>
<div class="outline-text-4" id="text-set-agenda-files-by-filetag">

<ul>
<li>Matt Lundin
</li>
</ul>


<p>
It is often helpful to limit yourself to a subset of your agenda
files. For instance, at work, you might want to see only files related
to work (e.g., bugs, clientA, projectxyz, etc.). The FAQ has helpful
information on filtering tasks using <a href="org-faq.html#limit-agenda-with-tag-filtering">filetags</a> and <a href="org-faq.html#limit-agenda-with-category-match">custom agenda commands</a>. These solutions, however, require reapplying a filter each
time you call the agenda or writing several new custom agenda commands
for each context. Another solution is to use directories for different
types of tasks and to change your agenda files with a function that
sets org-agenda-files to the appropriate directory. But this relies on
hard and static boundaries between files.
</p>
<p>
The following functions allow for a more dynamic approach to selecting
a subset of files based on filetags:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-agenda-restrict-files-by-filetag</span> (<span style="color: #b58900;">&amp;optional</span> tag)
  <span style="color: #2aa198; font-style: italic;">"Restrict org agenda files only to those containing filetag."</span>
  (interactive)
  (<span style="color: #859900; font-weight: bold;">let*</span> ((tagslist (my-org-get-all-filetags))
         (ftag (or tag
                   (completing-read <span style="color: #2aa198;">"Tag: "</span>
                                    (mapcar 'car tagslist)))))
    (org-agenda-remove-restriction-lock 'noupdate)
    (put 'org-agenda-files 'org-restrict (cdr (assoc ftag tagslist)))
    (setq org-agenda-overriding-restriction 'files)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-get-all-filetags</span> ()
  <span style="color: #2aa198; font-style: italic;">"Get list of filetags from all default org-files."</span>
  (<span style="color: #859900; font-weight: bold;">let</span> ((files org-agenda-files)
        tagslist x)
    (<span style="color: #859900; font-weight: bold;">save-window-excursion</span>
      (<span style="color: #859900; font-weight: bold;">while</span> (setq x (pop files))
        (set-buffer (find-file-noselect x))
        (mapc
         (<span style="color: #859900; font-weight: bold;">lambda</span> (y)
           (<span style="color: #859900; font-weight: bold;">let</span> ((tagfiles (assoc y tagslist)))
             (<span style="color: #859900; font-weight: bold;">if</span> tagfiles
                 (setcdr tagfiles (cons x (cdr tagfiles)))
               (add-to-list 'tagslist (list y x)))))
         (my-org-get-filetags)))
      tagslist)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-get-filetags</span> ()
  <span style="color: #2aa198; font-style: italic;">"Get list of filetags for current buffer"</span>
  (<span style="color: #859900; font-weight: bold;">let</span> ((ftags org-file-tags)
        x)
    (mapcar
     (<span style="color: #859900; font-weight: bold;">lambda</span> (x)
       (org-substring-no-properties x))
     ftags)))
</pre>


<p>
Calling my-org-agenda-restrict-files-by-filetag results in a prompt
with all filetags in your "normal" agenda files. When you select a
tag, org-agenda-files will be restricted to only those files
containing the filetag. To release the restriction, type C-c C-x &gt;
(org-agenda-remove-restriction-lock).
</p>
</div>

</div>

<div id="outline-container-1-8-3" class="outline-4">
<h4 id="sec-1-8-3">Highlight the agenda line under cursor</h4>
<div class="outline-text-4" id="text-1-8-3">

<p>This is useful to make sure what task you are operating on.
</p>



<pre class="src src-emacs-lisp">(add-hook 'org-agenda-mode-hook '(<span style="color: #859900; font-weight: bold;">lambda</span> () (hl-line-mode 1)))
</pre>


<p>
Under XEmacs:
</p>



<pre class="src src-emacs-lisp"><span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">hl-line seems to be only for emacs</span>
(<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #268bd2; font-weight: bold;">highline</span>)
(add-hook 'org-agenda-mode-hook '(<span style="color: #859900; font-weight: bold;">lambda</span> () (highline-mode 1)))

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">highline-mode does not work straightaway in tty mode.</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">I use a black background</span>
(custom-set-faces
  '(highline-face ((((type tty) (class color))
                    (<span style="color: #268bd2; font-style: italic;">:background</span> <span style="color: #2aa198;">"white"</span> <span style="color: #268bd2; font-style: italic;">:foreground</span> <span style="color: #2aa198;">"black"</span>)))))
</pre>


</div>

</div>

<div id="outline-container-1-8-4" class="outline-4">
<h4 id="sec-1-8-4">Split frame horizontally for agenda</h4>
<div class="outline-text-4" id="text-1-8-4">

<p>If you would like to split the frame into two side-by-side windows when
displaying the agenda, try this hack from Jan Rehders, which uses the
`toggle-window-split' from
</p>
<p>
<a href="http://www.emacswiki.org/cgi-bin/wiki/ToggleWindowSplit">http://www.emacswiki.org/cgi-bin/wiki/ToggleWindowSplit</a>
</p>



<pre class="src src-emacs-lisp"><span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Patch org-mode to use vertical splitting</span>
(<span style="color: #859900; font-weight: bold;">defadvice</span> <span style="color: #268bd2;">org-prepare-agenda</span> (after org-fix-split)
  (toggle-window-split))
(ad-activate 'org-prepare-agenda)
</pre>


</div>

</div>

<div id="outline-container-1-8-5" class="outline-4">
<h4 id="sec-1-8-5">Automatically add an appointment when clocking in a task</h4>
<div class="outline-text-4" id="text-1-8-5">




<pre class="src src-emacs-lisp"><span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Make sure you have a sensible value for `</span><span style="color: #268bd2; font-weight: bold;">appt-message-warning-time</span><span style="color: #93a1a1;">'</span>
(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">bzg-org-clock-in-appt-delay</span> 100
  <span style="color: #2aa198; font-style: italic;">"Number of minutes for setting an appointment by clocking-in"</span>)
</pre>


<p>
This function let's you add an appointment for the current entry.
This can be useful when you need a reminder.
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">bzg-org-clock-in-add-appt</span> (<span style="color: #b58900;">&amp;optional</span> n)
  <span style="color: #2aa198; font-style: italic;">"Add an appointment for the Org entry at point in N minutes."</span>
  (interactive)
  (<span style="color: #859900; font-weight: bold;">save-excursion</span>
    (org-back-to-heading t)
    (looking-at org-complex-heading-regexp)
    (<span style="color: #859900; font-weight: bold;">let*</span> ((msg (match-string-no-properties 4))
      (ct-time (decode-time))
      (appt-min (+ (cadr ct-time)
         (or n bzg-org-clock-in-appt-delay)))
      (appt-time <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">define the time for the appointment</span>
       (<span style="color: #859900; font-weight: bold;">progn</span> (setf (cadr ct-time) appt-min) ct-time)))
      (appt-add (format-time-string
       <span style="color: #2aa198;">"%H:%M"</span> (apply 'encode-time appt-time)) msg)
      (<span style="color: #859900; font-weight: bold;">if</span> (interactive-p) (message <span style="color: #2aa198;">"New appointment for %s"</span> msg)))))
</pre>


<p>
You can advise <code>org-clock-in</code> so that <code>C-c C-x C-i</code> will automatically
add an appointment:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defadvice</span> <span style="color: #268bd2;">org-clock-in</span> (after org-clock-in-add-appt activate)
  <span style="color: #2aa198; font-style: italic;">"Add an appointment when clocking a task in."</span>
  (bzg-org-clock-in-add-appt))
</pre>


<p>
You may also want to delete the associated appointment when clocking
out.  This function does this:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">bzg-org-clock-out-delete-appt</span> nil
  <span style="color: #2aa198; font-style: italic;">"When clocking out, delete any associated appointment."</span>
  (interactive)
  (<span style="color: #859900; font-weight: bold;">save-excursion</span>
    (org-back-to-heading t)
    (looking-at org-complex-heading-regexp)
    (<span style="color: #859900; font-weight: bold;">let*</span> ((msg (match-string-no-properties 4)))
      (setq appt-time-msg-list
       (delete nil
          (mapcar
           (<span style="color: #859900; font-weight: bold;">lambda</span> (appt)
             (<span style="color: #859900; font-weight: bold;">if</span> (not (string-match (regexp-quote msg)
                     (cadr appt))) appt))
           appt-time-msg-list)))
      (appt-check))))
</pre>


<p>
And here is the advice for <code>org-clock-out</code> (<code>C-c C-x C-o</code>)
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defadvice</span> <span style="color: #268bd2;">org-clock-out</span> (before org-clock-out-delete-appt activate)
  <span style="color: #2aa198; font-style: italic;">"Delete an appointment when clocking a task out."</span>
  (bzg-org-clock-out-delete-appt))
</pre>


<p>
<b>IMPORTANT</b>: You can add appointment by clocking in in both an
<code>org-mode</code> and an <code>org-agenda-mode</code> buffer.  But clocking out from
agenda buffer with the advice above will bring an error.
</p>
</div>

</div>

<div id="outline-container-1-8-6" class="outline-4">
<h4 id="sec-1-8-6">Using external programs for appointments reminders</h4>
<div class="outline-text-4" id="text-1-8-6">

<p>Read this rich <a href="http://comments.gmane.org/gmane.emacs.orgmode/46641">thread</a> from the org-mode list.
</p>
</div>

</div>

<div id="outline-container-1-8-7" class="outline-4">
<h4 id="sec-1-8-7">Remove from agenda time grid lines that are in an appointment</h4>
<div class="outline-text-4" id="text-1-8-7">

<p>The agenda shows lines for the time grid.  Some people think that
these lines are a distraction when there are appointments at those
times.  You can get rid of the lines which coincide exactly with the
beginning of an appointment.  Michael Ekstrand has written a piece of
advice that also removes lines that are somewhere inside an
appointment:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-time-to-minutes</span> (time)
  <span style="color: #2aa198; font-style: italic;">"Convert an HHMM time to minutes"</span>
  (+ (* (/ time 100) 60) (% time 100)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-time-from-minutes</span> (minutes)
  <span style="color: #2aa198; font-style: italic;">"Convert a number of minutes to an HHMM time"</span>
  (+ (* (/ minutes 60) 100) (% minutes 60)))

(<span style="color: #859900; font-weight: bold;">defadvice</span> <span style="color: #268bd2;">org-agenda-add-time-grid-maybe</span> (around mde-org-agenda-grid-tweakify
                                                  (list ndays todayp))
  (<span style="color: #859900; font-weight: bold;">if</span> (member 'remove-match (car org-agenda-time-grid))
      (<span style="color: #859900; font-weight: bold;">flet</span> ((extract-window
              (line)
              (<span style="color: #859900; font-weight: bold;">let</span> ((start (get-text-property 1 'time-of-day line))
                    (dur (get-text-property 1 'duration line)))
                (<span style="color: #859900; font-weight: bold;">cond</span>
                 ((and start dur)
                  (cons start
                        (org-time-from-minutes
                         (+ dur (org-time-to-minutes start)))))
                 (start start)
                 (t nil)))))
        (<span style="color: #859900; font-weight: bold;">let*</span> ((windows (delq nil (mapcar 'extract-window list)))
               (org-agenda-time-grid
                (list (car org-agenda-time-grid)
                      (cadr org-agenda-time-grid)
                      (remove-if
                       (<span style="color: #859900; font-weight: bold;">lambda</span> (time)
                         (find-if (<span style="color: #859900; font-weight: bold;">lambda</span> (w)
                                    (<span style="color: #859900; font-weight: bold;">if</span> (numberp w)
                                        (equal w time)
                                      (and (&gt;= time (car w))
                                           (&lt; time (cdr w)))))
                                  windows))
                       (caddr org-agenda-time-grid)))))
          ad-do-it))
    ad-do-it))
(ad-activate 'org-agenda-add-time-grid-maybe)
</pre>

</div>

</div>

<div id="outline-container-1-8-8" class="outline-4">
<h4 id="sec-1-8-8">Disable version control for Org mode agenda files</h4>
<div class="outline-text-4" id="text-1-8-8">

<p>&ndash; David Maus
</p>
<p>
Even if you use Git to track your agenda files you might not need
vc-mode to be enabled for these files.
</p>



<pre class="src src-emacs-lisp">(add-hook 'find-file-hook 'dmj/disable-vc-for-agenda-files-hook)
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">dmj/disable-vc-for-agenda-files-hook</span> ()
  <span style="color: #2aa198; font-style: italic;">"Disable vc-mode for Org agenda files."</span>
  (<span style="color: #859900; font-weight: bold;">if</span> (and (fboundp 'org-agenda-file-p)
           (org-agenda-file-p (buffer-file-name)))
      (remove-hook 'find-file-hook 'vc-find-file-hook)
    (add-hook 'find-file-hook 'vc-find-file-hook)))
</pre>


</div>

</div>

<div id="outline-container-1-8-9" class="outline-4">
<h4 id="sec-1-8-9">Easy customization of TODO colors</h4>
<div class="outline-text-4" id="text-1-8-9">


<p>
&ndash; Ryan C. Thompson
</p>
<p>
Here is some code I came up with some code to make it easier to
customize the colors of various TODO keywords. As long as you just
want a different color and nothing else, you can customize the
variable org-todo-keyword-faces and use just a string color (i.e. a
string of the color name) as the face, and then org-get-todo-face
will convert the color to a face, inheriting everything else from
the standard org-todo face.
</p>
<p>
To demonstrate, I currently have org-todo-keyword-faces set to
</p>



<pre class="src src-emacs-lisp">((<span style="color: #2aa198;">"IN PROGRESS"</span> . <span style="color: #2aa198;">"dark orange"</span>)
 (<span style="color: #2aa198;">"WAITING"</span> . <span style="color: #2aa198;">"red4"</span>)
 (<span style="color: #2aa198;">"CANCELED"</span> . <span style="color: #2aa198;">"saddle brown"</span>))
</pre>


<p>
  Here's the code, in a form you can put in your <code>.emacs</code>
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">eval-after-load</span> 'org-faces
 '(<span style="color: #859900; font-weight: bold;">progn</span>
    (<span style="color: #859900; font-weight: bold;">defcustom</span> <span style="color: #268bd2;">org-todo-keyword-faces</span> nil
      <span style="color: #2aa198; font-style: italic;">"Faces for specific TODO keywords.</span>
<span style="color: #2aa198; font-style: italic;">This is a list of cons cells, with TODO keywords in the car and</span>
<span style="color: #2aa198; font-style: italic;">faces in the cdr.  The face can be a symbol, a color, or a</span>
<span style="color: #2aa198; font-style: italic;">property list of attributes, like (:foreground \"blue\" :weight</span>
<span style="color: #2aa198; font-style: italic;">bold :underline t)."</span>
      <span style="color: #268bd2; font-style: italic;">:group</span> 'org-faces
      <span style="color: #268bd2; font-style: italic;">:group</span> 'org-todo
      <span style="color: #268bd2; font-style: italic;">:type</span> '(repeat
              (cons
               (string <span style="color: #268bd2; font-style: italic;">:tag</span> <span style="color: #2aa198;">"Keyword"</span>)
               (choice color (sexp <span style="color: #268bd2; font-style: italic;">:tag</span> <span style="color: #2aa198;">"Face"</span>)))))))

(<span style="color: #859900; font-weight: bold;">eval-after-load</span> 'org
 '(<span style="color: #859900; font-weight: bold;">progn</span>
    (<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-get-todo-face-from-color</span> (color)
      <span style="color: #2aa198; font-style: italic;">"Returns a specification for a face that inherits from org-todo</span>
<span style="color: #2aa198; font-style: italic;"> face and has the given color as foreground. Returns nil if</span>
<span style="color: #2aa198; font-style: italic;"> color is nil."</span>
      (<span style="color: #859900; font-weight: bold;">when</span> color
        `(<span style="color: #268bd2; font-style: italic;">:inherit</span> org-warning <span style="color: #268bd2; font-style: italic;">:foreground</span> ,color)))

    (<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-get-todo-face</span> (kwd)
      <span style="color: #2aa198; font-style: italic;">"Get the right face for a TODO keyword KWD.</span>
<span style="color: #2aa198; font-style: italic;">If KWD is a number, get the corresponding match group."</span>
      (<span style="color: #859900; font-weight: bold;">if</span> (numberp kwd) (setq kwd (match-string kwd)))
      (or (<span style="color: #859900; font-weight: bold;">let</span> ((face (cdr (assoc kwd org-todo-keyword-faces))))
            (<span style="color: #859900; font-weight: bold;">if</span> (stringp face)
                (org-get-todo-face-from-color face)
              face))
          (and (member kwd org-done-keywords) 'org-done)
          'org-todo))))
</pre>


</div>

</div>

<div id="outline-container-1-8-10" class="outline-4">
<h4 id="sec-1-8-10">Add an effort estimate on the fly when clocking in</h4>
<div class="outline-text-4" id="text-1-8-10">

<p>You can use <code>org-clock-in-prepare-hook</code> to add an effort estimate.
This way you can easily have a "tea-timer" for your tasks when they
don't already have an effort estimate.
</p>



<pre class="src src-emacs-lisp">(add-hook 'org-clock-in-prepare-hook
     'my-org-mode-ask-effort)

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-mode-ask-effort</span> ()
  <span style="color: #2aa198; font-style: italic;">"Ask for an effort estimate when clocking in."</span>
  (<span style="color: #859900; font-weight: bold;">unless</span> (org-entry-get (point) <span style="color: #2aa198;">"Effort"</span>)
    (<span style="color: #859900; font-weight: bold;">let</span> ((effort
      (completing-read
       <span style="color: #2aa198;">"Effort: "</span>
       (org-entry-get-multivalued-property (point) <span style="color: #2aa198;">"Effort"</span>))))
      (<span style="color: #859900; font-weight: bold;">unless</span> (equal effort <span style="color: #2aa198;">""</span>)
   (org-set-property <span style="color: #2aa198;">"Effort"</span> effort)))))
</pre>


<p>
Or you can use a default effort for such a timer:
</p>



<pre class="src src-emacs-lisp">(add-hook 'org-clock-in-prepare-hook
     'my-org-mode-add-default-effort)

(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">org-clock-default-effort</span> <span style="color: #2aa198;">"1:00"</span>)

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-mode-add-default-effort</span> ()
  <span style="color: #2aa198; font-style: italic;">"Add a default effort estimation."</span>
  (<span style="color: #859900; font-weight: bold;">unless</span> (org-entry-get (point) <span style="color: #2aa198;">"Effort"</span>)
    (org-set-property <span style="color: #2aa198;">"Effort"</span> org-clock-default-effort)))
</pre>


</div>

</div>

<div id="outline-container-1-8-11" class="outline-4">
<h4 id="sec-1-8-11">Use idle timer for automatic agenda views</h4>
<div class="outline-text-4" id="text-1-8-11">

<p>From John Wiegley's mailing list post (March 18, 2010):
</p>
<blockquote>

<p>I have the following snippet in my .emacs file, which I find very
useful. Basically what it does is that if I don't touch my Emacs for 5
minutes, it displays the current agenda. This keeps my tasks "always
in mind" whenever I come back to Emacs after doing something else,
whereas before I had a tendency to forget that it was there.
</p>
</blockquote>


<ul>
<li><a href="http://mid.gmane.org/55590EA7-C744-44E5-909F-755F0BBE452D@gmail.com">John Wiegley: Displaying your Org agenda after idle time</a>
</li>
</ul>





<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">jump-to-org-agenda</span> ()
  (interactive)
  (<span style="color: #859900; font-weight: bold;">let</span> ((buf (get-buffer <span style="color: #2aa198;">"*Org Agenda*"</span>))
        wind)
    (<span style="color: #859900; font-weight: bold;">if</span> buf
        (<span style="color: #859900; font-weight: bold;">if</span> (setq wind (get-buffer-window buf))
            (select-window wind)
          (<span style="color: #859900; font-weight: bold;">if</span> (called-interactively-p)
              (<span style="color: #859900; font-weight: bold;">progn</span>
                (select-window (display-buffer buf t t))
                (org-fit-window-to-buffer)
                <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">(org-agenda-redo)</span>
                )
            (<span style="color: #859900; font-weight: bold;">with-selected-window</span> (display-buffer buf)
              (org-fit-window-to-buffer)
              <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">(org-agenda-redo)</span>
              )))
      (call-interactively 'org-agenda-list)))
  <span style="color: #93a1a1;">;;</span><span style="color: #93a1a1;">(let ((buf (get-buffer "*Calendar*")))</span>
  <span style="color: #93a1a1;">;;  </span><span style="color: #93a1a1;">(unless (get-buffer-window buf)</span>
  <span style="color: #93a1a1;">;;    </span><span style="color: #93a1a1;">(org-agenda-goto-calendar)))</span>
  )

(run-with-idle-timer 300 t 'jump-to-org-agenda)
</pre>


</div>

</div>

<div id="outline-container-1-8-12" class="outline-4">
<h4 id="sec-1-8-12">Refresh the agenda view regularly</h4>
<div class="outline-text-4" id="text-1-8-12">

<p>Hack sent by Kiwon Um:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">kiwon/org-agenda-redo-in-other-window</span> ()
  <span style="color: #2aa198; font-style: italic;">"Call org-agenda-redo function even in the non-agenda buffer."</span>
  (interactive)
  (<span style="color: #859900; font-weight: bold;">let</span> ((agenda-window (get-buffer-window org-agenda-buffer-name t)))
    (<span style="color: #859900; font-weight: bold;">when</span> agenda-window
      (<span style="color: #859900; font-weight: bold;">with-selected-window</span> agenda-window (org-agenda-redo)))))
(run-at-time nil 300 'kiwon/org-agenda-redo-in-other-window)
</pre>


</div>

</div>

<div id="outline-container-1-8-13" class="outline-4">
<h4 id="sec-1-8-13">Reschedule agenda items to today with a single command</h4>
<div class="outline-text-4" id="text-1-8-13">

<p>This was suggested by Carsten in reply to David Abrahams:
</p>



<pre class="example">(defun org-agenda-reschedule-to-today ()
  (interactive)
  (flet ((org-read-date (&amp;rest rest) (current-time)))
    (call-interactively 'org-agenda-schedule)))
</pre>


</div>

</div>

<div id="outline-container-1-8-14" class="outline-4">
<h4 id="sec-1-8-14">Mark subtree DONE along with all subheadings</h4>
<div class="outline-text-4" id="text-1-8-14">

<p>Bernt Hansen <a href="http://permalink.gmane.org/gmane.emacs.orgmode/44693">suggested</a> this command:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">bh/mark-subtree-done</span> ()
  (interactive)
  (org-mark-subtree)
  (<span style="color: #859900; font-weight: bold;">let</span> ((limit (point)))
    (<span style="color: #859900; font-weight: bold;">save-excursion</span>
      (exchange-point-and-mark)
      (<span style="color: #859900; font-weight: bold;">while</span> (&gt; (point) limit)
   (org-todo <span style="color: #2aa198;">"DONE"</span>)
   (outline-previous-visible-heading 1))
      (org-todo <span style="color: #2aa198;">"DONE"</span>))))
</pre>


<p>
Then M-x bh/mark-subtree-done.
</p>
</div>

</div>

<div id="outline-container-mark-done-when-all-checkboxes-checked" class="outline-4">
<h4 id="mark-done-when-all-checkboxes-checked"><a name="sec-1-8-15" id="sec-1-8-15"></a>Mark heading done when all checkboxes are checked.</h4>
<div class="outline-text-4" id="text-mark-done-when-all-checkboxes-checked">



<p>
An item consists of a list with checkboxes.  When all of the
checkboxes are checked, the item should be considered complete and its
TODO state should be automatically changed to DONE. The code below
does that. This version is slightly enhanced over the one in the
mailing list (see
<a href="http://thread.gmane.org/gmane.emacs.orgmode/42715/focus=42721">http://thread.gmane.org/gmane.emacs.orgmode/42715/focus=42721</a>) to
reset the state back to TODO if a checkbox is unchecked.
</p>
<p>
Note that the code requires that a checkbox statistics cookie (the [/]
or [%] thingie in the headline - see the <a href="http://orgmode.org/manual/Checkboxes.html#Checkboxes">Checkboxes</a> section in the
manual) be present in order for it to work. Note also that it is too
dumb to figure out whether the item has a TODO state in the first
place: if there is a statistics cookie, a TODO/DONE state will be
added willy-nilly any time that the statistics cookie is changed.
</p>



<pre class="src src-emacs-lisp"><span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">see http://thread.gmane.org/gmane.emacs.orgmode/42715</span>
(<span style="color: #859900; font-weight: bold;">eval-after-load</span> 'org-list
  '(add-hook 'org-checkbox-statistics-hook (function ndk/checkbox-list-complete)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ndk/checkbox-list-complete</span> ()
  (<span style="color: #859900; font-weight: bold;">save-excursion</span>
    (org-back-to-heading t)
    (<span style="color: #859900; font-weight: bold;">let</span> ((beg (point)) end)
      (end-of-line)
      (setq end (point))
      (goto-char beg)
      (<span style="color: #859900; font-weight: bold;">if</span> (re-search-forward <span style="color: #2aa198;">"\\[</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[0-9]*%</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">\\]</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">|</span><span style="color: #2aa198;">\\[</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[0-9]*</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">/</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">[0-9]*</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">\\]"</span> end t)
            (<span style="color: #859900; font-weight: bold;">if</span> (match-end 1)
                (<span style="color: #859900; font-weight: bold;">if</span> (equal (match-string 1) <span style="color: #2aa198;">"100%"</span>)
                    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">all done - do the state change</span>
                    (org-todo 'done)
                  (org-todo 'todo))
              (<span style="color: #859900; font-weight: bold;">if</span> (and (&gt; (match-end 2) (match-beginning 2))
                       (equal (match-string 2) (match-string 3)))
                  (org-todo 'done)
                (org-todo 'todo)))))))
</pre>


</div>
</div>

</div>

<div id="outline-container-1-9" class="outline-3">
<h3 id="sec-1-9">Exporting org files</h3>
<div class="outline-text-3" id="text-1-9">


</div>

<div id="outline-container-1-9-1" class="outline-4">
<h4 id="sec-1-9-1">Export Org to Org and handle includes.</h4>
<div class="outline-text-4" id="text-1-9-1">

<p>Nick Dokos came up with this useful function:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">org-to-org-handle-includes</span> ()
  <span style="color: #2aa198; font-style: italic;">"Copy the contents of the current buffer to OUTFILE,</span>
<span style="color: #2aa198; font-style: italic;">recursively processing #+INCLUDEs."</span>
  (<span style="color: #859900; font-weight: bold;">let*</span> ((s (buffer-string))
    (fname (buffer-file-name))
    (ofname (format <span style="color: #2aa198;">"%s.I.org"</span> (file-name-sans-extension fname))))
    (setq result
     (<span style="color: #859900; font-weight: bold;">with-temp-buffer</span>
       (insert s)
       (org-export-handle-include-files-recurse)
       (buffer-string)))
    (find-file ofname)
    (delete-region (point-min) (point-max))
    (insert result)
    (save-buffer)))
</pre>


</div>

</div>

<div id="outline-container-latex-command-for-floats" class="outline-4">
<h4 id="latex-command-for-floats"><a name="sec-1-9-2" id="sec-1-9-2"></a>Specifying LaTeX commands to floating environments</h4>
<div class="outline-text-4" id="text-latex-command-for-floats">


<p>
The keyword <code>placement</code> can be used to specify placement options to
floating environments (like <code>\begin{figure}</code> and <code>\begin{table}</code>}) in
LaTeX export. Org passes along everything passed in options as long as
there are no spaces. One can take advantage of this to pass other
LaTeX commands and have their scope limited to the floating
environment.
</p>
<p>
For example one can set the fontsize of a table different from the
default normal size by putting something like <code>\footnotesize</code> right
after the placement options. During LaTeX export using the
<code>#+ATTR_LaTeX:</code> line below:
</p>



<pre class="src src-org"><span style="color: #93a1a1;">#+ATTR_LaTeX: placement=[&lt;options&gt;]\footnotesize</span>
</pre>


<p>
exports the associated floating environment as shown in the following
block.
</p>



<pre class="src src-latex"><span style="color: #859900; font-weight: bold;">\begin</span>{<span style="color: #268bd2;">table</span>}[&lt;options&gt;]<span style="color: #859900; font-weight: bold;">\footnotesize</span>
...
<span style="color: #859900; font-weight: bold;">\end</span>{<span style="color: #268bd2;">table</span>}
</pre>


<p>
It should be noted that this hack does not work for beamer export of
tables since the <code>table</code> environment is not used. As an ugly
workaround, one can use the following:
</p>



<pre class="src src-org"><span style="color: #93a1a1;">#+LATEX:</span><span style="color: #93a1a1;"> </span><span style="color: #93a1a1;">{\footnotesize</span>
<span style="color: #93a1a1;">#+ATTR_LaTeX: align=rr</span>
<span style="color: #859900;">| some | table |</span>
<span style="color: #859900;">|------+-------|</span>
<span style="color: #859900;">| ..   | ..    |</span>
<span style="color: #93a1a1;">#+LATEX:</span><span style="color: #93a1a1;"> </span><span style="color: #93a1a1;">}</span>
</pre>


</div>

</div>

<div id="outline-container-1-9-3" class="outline-4">
<h4 id="sec-1-9-3">Styling code sections with CSS</h4>
<div class="outline-text-4" id="text-1-9-3">



<p>
Code sections (marked with <code>#+begin_src</code> and <code>#+end_src</code>) are exported
to HTML using <code>&lt;pre&gt;</code> tags, and assigned CSS classes by their content
type.  For example, Perl content will have an opening tag like
<code>&lt;pre class</code>"src src-perl"&gt;=.  You can use those classes to add styling
to the output, such as here where a small language tag is added at the
top of each kind of code box:
</p>



<pre class="src src-lisp">(setq org-export-html-style
 <span style="color: #2aa198;">"&lt;style type=\"text/css\"&gt;</span>
<span style="color: #2aa198;">    &lt;!--/*--&gt;&lt;![CDATA[/*&gt;&lt;!--*/</span>
<span style="color: #2aa198;">      .src             { background-color: #F5FFF5; position: relative; overflow: visible; }</span>
<span style="color: #2aa198;">      .src:before      { position: absolute; top: -15px; background: #ffffff; padding: 1px; border: 1px solid #000000; font-size: small; }</span>
<span style="color: #2aa198;">      .src-sh:before   { content: 'sh'; }</span>
<span style="color: #2aa198;">      .src-bash:before { content: 'sh'; }</span>
<span style="color: #2aa198;">      .src-R:before    { content: 'R'; }</span>
<span style="color: #2aa198;">      .src-perl:before { content: 'Perl'; }</span>
<span style="color: #2aa198;">      .src-sql:before  { content: 'SQL'; }</span>
<span style="color: #2aa198;">      .example         { background-color: #FFF5F5; }</span>
<span style="color: #2aa198;">    /*]]&gt;*/--&gt;</span>
<span style="color: #2aa198;"> &lt;/style&gt;"</span>)
</pre>


<p>
Additionally, we use color to distinguish code output (the <code>.example</code>
class) from input (all the <code>.src-*</code> classes).
</p>
</div>
</div>
</div>

</div>

<div id="outline-container-2" class="outline-2">
<h2 id="sec-2">Hacking Org: Working with Org-mode and other Emacs Packages.</h2>
<div class="outline-text-2" id="text-2">


</div>

<div id="outline-container-2-1" class="outline-3">
<h3 id="sec-2-1">org-remember-anything</h3>
<div class="outline-text-3" id="text-2-1">



<p>
<a href="http://www.emacswiki.org/cgi-bin/wiki/Anything">Anything</a> users may find the snippet below interesting:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">org-remember-anything</span>
  '((name . <span style="color: #2aa198;">"Org Remember"</span>)
    (candidates . (<span style="color: #859900; font-weight: bold;">lambda</span> () (mapcar 'car org-remember-templates)))
    (action . (<span style="color: #859900; font-weight: bold;">lambda</span> (name)
                (<span style="color: #859900; font-weight: bold;">let*</span> ((orig-template org-remember-templates)
                       (org-remember-templates
                        (list (assoc name orig-template))))
                  (call-interactively 'org-remember))))))
</pre>


<p>
You can add it to your 'anything-sources' variable and open remember directly
from anything. I imagine this would be more interesting for people with many
remember templates, so that you are out of keys to assign those to.
</p>
</div>

</div>

<div id="outline-container-2-2" class="outline-3">
<h3 id="sec-2-2">Org-mode and saveplace.el</h3>
<div class="outline-text-3" id="text-2-2">


<p>
Fix a problem with <code>saveplace.el</code> putting you back in a folded position:
</p>



<pre class="src src-emacs-lisp">(add-hook 'org-mode-hook
          (<span style="color: #859900; font-weight: bold;">lambda</span> ()
       (<span style="color: #859900; font-weight: bold;">when</span> (outline-invisible-p)
         (<span style="color: #859900; font-weight: bold;">save-excursion</span>
      (outline-previous-visible-heading 1)
      (org-show-subtree)))))
</pre>


</div>

</div>

<div id="outline-container-2-3" class="outline-3">
<h3 id="sec-2-3">Using ido-completing-read to find attachments</h3>
<div class="outline-text-3" id="text-2-3">



<p>
&ndash; Matt Lundin.
</p>
<p>
Org-attach is great for quickly linking files to a project. But if you
use org-attach extensively you might find yourself wanting to browse
all the files you've attached to org headlines. This is not easy to do
manually, since the directories containing the files are not human
readable (i.e., they are based on automatically generated ids). Here's
some code to browse those files using ido (obviously, you need to be
using ido):
</p>



<pre class="src src-emacs-lisp">(load-library <span style="color: #2aa198;">"find-lisp"</span>)

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Adapted from http://www.emacswiki.org/emacs/RecentFiles</span>

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-ido-find-org-attach</span> ()
  <span style="color: #2aa198; font-style: italic;">"Find files in org-attachment directory"</span>
  (interactive)
  (<span style="color: #859900; font-weight: bold;">let*</span> ((enable-recursive-minibuffers t)
         (files (find-lisp-find-files org-attach-directory <span style="color: #2aa198;">"."</span>))
         (file-assoc-list
          (mapcar (<span style="color: #859900; font-weight: bold;">lambda</span> (x)
                    (cons (file-name-nondirectory x)
                          x))
                  files))
         (filename-list
          (remove-duplicates (mapcar #'car file-assoc-list)
                             <span style="color: #268bd2; font-style: italic;">:test</span> #'string=))
         (filename (ido-completing-read <span style="color: #2aa198;">"Org attachments: "</span> filename-list nil t))
         (longname (cdr (assoc filename file-assoc-list))))
    (ido-set-current-directory
     (<span style="color: #859900; font-weight: bold;">if</span> (file-directory-p longname)
         longname
       (file-name-directory longname)))
    (setq ido-exit 'refresh
          ido-text-init ido-text
          ido-rotate-temp t)
    (exit-minibuffer)))

(add-hook 'ido-setup-hook 'ido-my-keys)

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ido-my-keys</span> ()
  <span style="color: #2aa198; font-style: italic;">"Add my keybindings for ido."</span>
  (define-key ido-completion-map (kbd <span style="color: #2aa198;">"C-;"</span>) 'my-ido-find-org-attach))
</pre>


<p>
To browse your org attachments using ido fuzzy matching and/or the
completion buffer, invoke ido-find-file as usual (<code>C-x C-f</code>) and then
press <code>C-;</code>.
</p>
</div>

</div>

<div id="outline-container-2-4" class="outline-3">
<h3 id="sec-2-4">Link to Gnus messages by Message-Id</h3>
<div class="outline-text-3" id="text-2-4">

<p>In a <a href="http://thread.gmane.org/gmane.emacs.orgmode/8860">recent thread</a> on the Org-Mode mailing list, there was some
discussion about linking to Gnus messages without encoding the folder
name in the link.  The following code hooks in to the store-link
function in Gnus to capture links by Message-Id when in nnml folders,
and then provides a link type "mid" which can open this link.  The
<code>mde-org-gnus-open-message-link</code> function uses the
<code>mde-mid-resolve-methods</code> variable to determine what Gnus backends to
scan.  It will go through them, in order, asking each to locate the
message and opening it from the first one that reports success.
</p>
<p>
It has only been tested with a single nnml backend, so there may be
bugs lurking here and there.
</p>
<p>
The logic for finding the message was adapted from <a href="http://www.emacswiki.org/cgi-bin/wiki/FindMailByMessageId">an Emacs Wiki article</a>.
</p>



<pre class="src src-emacs-lisp"><span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Support for saving Gnus messages by Message-ID</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">mde-org-gnus-save-by-mid</span> ()
  (<span style="color: #859900; font-weight: bold;">when</span> (memq major-mode '(gnus-summary-mode gnus-article-mode))
    (<span style="color: #859900; font-weight: bold;">when</span> (eq major-mode 'gnus-article-mode)
      (gnus-article-show-summary))
    (<span style="color: #859900; font-weight: bold;">let*</span> ((group gnus-newsgroup-name)
           (method (gnus-find-method-for-group group)))
      (<span style="color: #859900; font-weight: bold;">when</span> (eq 'nnml (car method))
        (<span style="color: #859900; font-weight: bold;">let*</span> ((article (gnus-summary-article-number))
               (header (gnus-summary-article-header article))
               (from (mail-header-from header))
               (message-id
                (<span style="color: #859900; font-weight: bold;">save-match-data</span>
                  (<span style="color: #859900; font-weight: bold;">let</span> ((mid (mail-header-id header)))
                    (<span style="color: #859900; font-weight: bold;">if</span> (string-match <span style="color: #2aa198;">"&lt;</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">.*</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">&gt;"</span> mid)
                        (match-string 1 mid)
                      (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span> <span style="color: #2aa198;">"Malformed message ID header %s"</span> mid)))))
               (date (mail-header-date header))
               (subject (gnus-summary-subject-string)))
          (org-store-link-props <span style="color: #268bd2; font-style: italic;">:type</span> <span style="color: #2aa198;">"mid"</span> <span style="color: #268bd2; font-style: italic;">:from</span> from <span style="color: #268bd2; font-style: italic;">:subject</span> subject
                                <span style="color: #268bd2; font-style: italic;">:message-id</span> message-id <span style="color: #268bd2; font-style: italic;">:group</span> group
                                <span style="color: #268bd2; font-style: italic;">:link</span> (org-make-link <span style="color: #2aa198;">"mid:"</span> message-id))
          (apply 'org-store-link-props
                 <span style="color: #268bd2; font-style: italic;">:description</span> (org-email-link-description)
                 org-store-link-plist)
          t)))))

(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">mde-mid-resolve-methods</span> '()
  <span style="color: #2aa198; font-style: italic;">"List of methods to try when resolving message ID's.  For Gnus,</span>
<span style="color: #2aa198; font-style: italic;">it is a cons of 'gnus and the select (type and name)."</span>)
(setq mde-mid-resolve-methods
      '((gnus nnml <span style="color: #2aa198;">""</span>)))

(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">mde-org-gnus-open-level</span> 1
  <span style="color: #2aa198; font-style: italic;">"Level at which Gnus is started when opening a link"</span>)
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">mde-org-gnus-open-message-link</span> (msgid)
  <span style="color: #2aa198; font-style: italic;">"Open a message link with Gnus"</span>
  (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #268bd2; font-weight: bold;">gnus</span>)
  (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #268bd2; font-weight: bold;">org-table</span>)
  (<span style="color: #859900; font-weight: bold;">catch</span> '<span style="color: #268bd2; font-weight: bold;">method-found</span>
    (message <span style="color: #2aa198;">"[MID linker] Resolving %s"</span> msgid)
    (<span style="color: #859900; font-weight: bold;">dolist</span> (method mde-mid-resolve-methods)
      (<span style="color: #859900; font-weight: bold;">cond</span>
       ((and (eq (car method) 'gnus)
             (eq (cadr method) 'nnml))
        (funcall (cdr (assq 'gnus org-link-frame-setup))
                 mde-org-gnus-open-level)
        (<span style="color: #859900; font-weight: bold;">when</span> gnus-other-frame-object
          (select-frame gnus-other-frame-object))
        (<span style="color: #859900; font-weight: bold;">let*</span> ((msg-info (nnml-find-group-number
                          (concat <span style="color: #2aa198;">"&lt;"</span> msgid <span style="color: #2aa198;">"&gt;"</span>)
                          (cdr method)))
               (group (and msg-info (car msg-info)))
               (message (and msg-info (cdr msg-info)))
               (qname (and group
                           (<span style="color: #859900; font-weight: bold;">if</span> (gnus-methods-equal-p
                                (cdr method)
                                gnus-select-method)
                               group
                             (gnus-group-full-name group (cdr method))))))
          (<span style="color: #859900; font-weight: bold;">when</span> msg-info
            (gnus-summary-read-group qname nil t)
            (gnus-summary-goto-article message nil t))
          (<span style="color: #859900; font-weight: bold;">throw</span> '<span style="color: #268bd2; font-weight: bold;">method-found</span> t)))
       (t (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span> <span style="color: #2aa198;">"Unknown link type"</span>))))))

(<span style="color: #859900; font-weight: bold;">eval-after-load</span> 'org-gnus
  '(<span style="color: #859900; font-weight: bold;">progn</span>
     (add-to-list 'org-store-link-functions 'mde-org-gnus-save-by-mid)
     (org-add-link-type <span style="color: #2aa198;">"mid"</span> 'mde-org-gnus-open-message-link)))
</pre>


</div>

</div>

<div id="outline-container-2-5" class="outline-3">
<h3 id="sec-2-5">Store link to a message when sending in Gnus</h3>
<div class="outline-text-3" id="text-2-5">

<p>Ulf Stegemann came up with this solution (see his <a href="http://www.mail-archive.com/emacs-orgmode@gnu.org/msg33278.html">original message</a>):
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ulf-message-send-and-org-gnus-store-link</span> (<span style="color: #b58900;">&amp;optional</span> arg)
  <span style="color: #2aa198; font-style: italic;">"Send message with `</span><span style="color: #268bd2; font-weight: bold; font-style: italic;">message-send-and-exit</span><span style="color: #2aa198; font-style: italic;">' and store org link to message copy.</span>
<span style="color: #2aa198; font-style: italic;">If multiple groups appear in the Gcc header, the link refers to</span>
<span style="color: #2aa198; font-style: italic;">the copy in the last group."</span>
  (interactive <span style="color: #2aa198;">"P"</span>)
    (<span style="color: #859900; font-weight: bold;">save-excursion</span>
      (<span style="color: #859900; font-weight: bold;">save-restriction</span>
   (message-narrow-to-headers)
   (<span style="color: #859900; font-weight: bold;">let</span> ((gcc (car (last
          (message-unquote-tokens
           (message-tokenize-header
            (mail-fetch-field <span style="color: #2aa198;">"gcc"</span> nil t) <span style="color: #2aa198;">" ,"</span>)))))
         (buf (current-buffer))
         (message-kill-buffer-on-exit nil)
         id to from subject desc link newsgroup xarchive)
        (message-send-and-exit arg)
        (or
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">gcc group found ...</span>
         (and gcc
              (<span style="color: #859900; font-weight: bold;">save-current-buffer</span>
                (<span style="color: #859900; font-weight: bold;">progn</span> (set-buffer buf)
                       (setq id (org-remove-angle-brackets
                                 (mail-fetch-field <span style="color: #2aa198;">"Message-ID"</span>)))
                       (setq to (mail-fetch-field <span style="color: #2aa198;">"To"</span>))
                       (setq from (mail-fetch-field <span style="color: #2aa198;">"From"</span>))
                       (setq subject (mail-fetch-field <span style="color: #2aa198;">"Subject"</span>))))
              (org-store-link-props <span style="color: #268bd2; font-style: italic;">:type</span> <span style="color: #2aa198;">"gnus"</span> <span style="color: #268bd2; font-style: italic;">:from</span> from <span style="color: #268bd2; font-style: italic;">:subject</span> subject
                                    <span style="color: #268bd2; font-style: italic;">:message-id</span> id <span style="color: #268bd2; font-style: italic;">:group</span> gcc <span style="color: #268bd2; font-style: italic;">:to</span> to)
              (setq desc (org-email-link-description))
              (setq link (org-gnus-article-link
                          gcc newsgroup id xarchive))
              (setq org-stored-links
                    (cons (list link desc) org-stored-links)))
         <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">no gcc group found ...</span>
         (message <span style="color: #2aa198;">"Can not create Org link: No Gcc header found."</span>))))))

(define-key message-mode-map [(control c) (control meta c)]
  'ulf-message-send-and-org-gnus-store-link)
</pre>


</div>

</div>

<div id="outline-container-2-6" class="outline-3">
<h3 id="sec-2-6">Send html messages and attachments with Wanderlust</h3>
<div class="outline-text-3" id="text-2-6">

<p>  &ndash; David Maus
</p>
<p>
<i>Note</i>: The module <a href="org-contrib/org-mime.html">Org-mime</a> in Org's contrib directory provides
similar functionality for both Wanderlust and Gnus.  The hack below is
still somewhat different: It allows you to toggle sending of html
messages within Wanderlust transparently.  I.e. html markup of the
message body is created right before sending starts.
</p>

</div>

<div id="outline-container-2-6-1" class="outline-4">
<h4 id="sec-2-6-1">Send HTML message</h4>
<div class="outline-text-4" id="text-2-6-1">


<p>
Putting the code below in your .emacs adds following four functions:
</p>
<ul>
<li>dmj/wl-send-html-message

<p>
  Function that does the job: Convert everything between "&ndash;text
  follows this line&ndash;" and first mime entity (read: attachment) or
  end of buffer into html markup using `org-export-region-as-html'
  and replaces original body with a multipart MIME entity with the
  plain text version of body and the html markup version.  Thus a
  recipient that prefers html messages can see the html markup,
  recipients that prefer or depend on plain text can see the plain
  text.
</p>
<p>
  Cannot be called interactively: It is hooked into SEMI's
  `mime-edit-translate-hook' if message should be HTML message.
</p>
</li>
<li>dmj/wl-send-html-message-draft-init

<p>
  Cannot be called interactively: It is hooked into WL's
  `wl-mail-setup-hook' and provides a buffer local variable to
  toggle.
</p>
</li>
<li>dmj/wl-send-html-message-draft-maybe

<p>
  Cannot be called interactively: It is hooked into WL's
  `wl-draft-send-hook' and hooks `dmj/wl-send-html-message' into
  `mime-edit-translate-hook' depending on whether HTML message is
  toggled on or off
</p>
</li>
<li>dmj/wl-send-html-message-toggle

<p>
  Toggles sending of HTML message.  If toggled on, the letters
  "HTML" appear in the mode line.
</p>
<p>
  Call it interactively!  Or bind it to a key in `wl-draft-mode'.
</p></li>
</ul>


<p>
If you have to send HTML messages regularly you can set a global
variable `dmj/wl-send-html-message-toggled-p' to the string "HTML" to
toggle on sending HTML message by default.
</p>
<p>
The image <a href="http://s11.directupload.net/file/u/15851/48ru5wl3.png">here</a> shows an example of how the HTML message looks like in
Google's web front end.  As you can see you have the whole markup of
Org at your service: <b>bold</b>, <i>italics</i>, tables, lists&hellip;
</p>
<p>
So even if you feel uncomfortable with sending HTML messages at least
you send HTML that looks quite good.
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">dmj/wl-send-html-message</span> ()
  <span style="color: #2aa198; font-style: italic;">"Send message as html message.</span>
<span style="color: #2aa198; font-style: italic;">Convert body of message to html using</span>
<span style="color: #2aa198; font-style: italic;">  `</span><span style="color: #268bd2; font-weight: bold; font-style: italic;">org-export-region-as-html</span><span style="color: #2aa198; font-style: italic;">'."</span>
  (<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #268bd2; font-weight: bold;">org</span>)
  (<span style="color: #859900; font-weight: bold;">save-excursion</span>
    (<span style="color: #859900; font-weight: bold;">let</span> (beg end html text)
      (goto-char (point-min))
      (re-search-forward <span style="color: #2aa198;">"^--text follows this line--$"</span>)
      <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">move to beginning of next line</span>
      (beginning-of-line 2)
      (setq beg (point))
      (<span style="color: #859900; font-weight: bold;">if</span> (not (re-search-forward <span style="color: #2aa198;">"^--\\[\\["</span> nil t))
          (setq end (point-max))
        <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">line up</span>
        (end-of-line 0)
        (setq end (point)))
      <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">grab body</span>
      (setq text (buffer-substring-no-properties beg end))
      <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">convert to html</span>
      (<span style="color: #859900; font-weight: bold;">with-temp-buffer</span>
        (org-mode)
        (insert text)
        <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">handle signature</span>
        (<span style="color: #859900; font-weight: bold;">when</span> (re-search-backward <span style="color: #2aa198;">"^-- \n"</span> nil t)
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">preserve link breaks in signature</span>
          (insert <span style="color: #2aa198;">"\n#+BEGIN_VERSE\n"</span>)
          (goto-char (point-max))
          (insert <span style="color: #2aa198;">"\n#+END_VERSE\n"</span>)
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">grab html</span>
          (setq html (org-export-region-as-html
                      (point-min) (point-max) t 'string))))
      (delete-region beg end)
      (insert
       (concat
        <span style="color: #2aa198;">"--"</span> <span style="color: #2aa198;">"&lt;&lt;alternative&gt;&gt;-{\n"</span>
        <span style="color: #2aa198;">"--"</span> <span style="color: #2aa198;">"[[text/plain]]\n"</span> text
        <span style="color: #2aa198;">"--"</span> <span style="color: #2aa198;">"[[text/html]]\n"</span>  html
        <span style="color: #2aa198;">"--"</span> <span style="color: #2aa198;">"}-&lt;&lt;alternative&gt;&gt;\n"</span>)))))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">dmj/wl-send-html-message-toggle</span> ()
  <span style="color: #2aa198; font-style: italic;">"Toggle sending of html message."</span>
  (interactive)
  (setq dmj/wl-send-html-message-toggled-p
        (<span style="color: #859900; font-weight: bold;">if</span> dmj/wl-send-html-message-toggled-p
            nil <span style="color: #2aa198;">"HTML"</span>))
  (message <span style="color: #2aa198;">"Sending html message toggled %s"</span>
           (<span style="color: #859900; font-weight: bold;">if</span> dmj/wl-send-html-message-toggled-p
               <span style="color: #2aa198;">"on"</span> <span style="color: #2aa198;">"off"</span>)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">dmj/wl-send-html-message-draft-init</span> ()
  <span style="color: #2aa198; font-style: italic;">"Create buffer local settings for maybe sending html message."</span>
  (<span style="color: #859900; font-weight: bold;">unless</span> (boundp 'dmj/wl-send-html-message-toggled-p)
    (setq dmj/wl-send-html-message-toggled-p nil))
  (make-variable-buffer-local 'dmj/wl-send-html-message-toggled-p)
  (add-to-list 'global-mode-string
               '(<span style="color: #268bd2; font-style: italic;">:eval</span> (<span style="color: #859900; font-weight: bold;">if</span> (eq major-mode 'wl-draft-mode)
                           dmj/wl-send-html-message-toggled-p))))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">dmj/wl-send-html-message-maybe</span> ()
  <span style="color: #2aa198; font-style: italic;">"Maybe send this message as html message.</span>

<span style="color: #2aa198; font-style: italic;">If buffer local variable `</span><span style="color: #268bd2; font-weight: bold; font-style: italic;">dmj/wl-send-html-message-toggled-p</span><span style="color: #2aa198; font-style: italic;">' is</span>
<span style="color: #2aa198; font-style: italic;">non-nil, add `</span><span style="color: #268bd2; font-weight: bold; font-style: italic;">dmj/wl-send-html-message</span><span style="color: #2aa198; font-style: italic;">' to</span>
<span style="color: #2aa198; font-style: italic;">`</span><span style="color: #268bd2; font-weight: bold; font-style: italic;">mime-edit-translate-hook</span><span style="color: #2aa198; font-style: italic;">'."</span>
  (<span style="color: #859900; font-weight: bold;">if</span> dmj/wl-send-html-message-toggled-p
      (add-hook 'mime-edit-translate-hook 'dmj/wl-send-html-message)
    (remove-hook 'mime-edit-translate-hook 'dmj/wl-send-html-message)))

(add-hook 'wl-draft-reedit-hook 'dmj/wl-send-html-message-draft-init)
(add-hook 'wl-mail-setup-hook 'dmj/wl-send-html-message-draft-init)
(add-hook 'wl-draft-send-hook 'dmj/wl-send-html-message-maybe)
</pre>


</div>

</div>

<div id="outline-container-2-6-2" class="outline-4">
<h4 id="sec-2-6-2">Attach HTML of region or subtree</h4>
<div class="outline-text-4" id="text-2-6-2">


<p>
Instead of sending a complete HTML message you might only send parts
of an Org file as HTML for the poor souls who are plagued with
non-proportional fonts in their mail program that messes up pretty
ASCII tables.
</p>
<p>
This short function does the trick: It exports region or subtree to
HTML, prefixes it with a MIME entity delimiter and pushes to killring
and clipboard.  If a region is active, it uses the region, the
complete subtree otherwise.
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">dmj/org-export-region-as-html-attachment</span> (beg end arg)
  <span style="color: #2aa198; font-style: italic;">"Export region between BEG and END as html attachment.</span>
<span style="color: #2aa198; font-style: italic;">If BEG and END are not set, use current subtree.  Region or</span>
<span style="color: #2aa198; font-style: italic;">subtree is exported to html without header and footer, prefixed</span>
<span style="color: #2aa198; font-style: italic;">with a mime entity string and pushed to clipboard and killring.</span>
<span style="color: #2aa198; font-style: italic;">When called with prefix, mime entity is not marked as</span>
<span style="color: #2aa198; font-style: italic;">attachment."</span>
  (interactive <span style="color: #2aa198;">"r\nP"</span>)
  (<span style="color: #859900; font-weight: bold;">save-excursion</span>
    (<span style="color: #859900; font-weight: bold;">let*</span> ((beg (<span style="color: #859900; font-weight: bold;">if</span> (region-active-p) (region-beginning)
                  (<span style="color: #859900; font-weight: bold;">progn</span>
                    (org-back-to-heading)
                    (point))))
           (end (<span style="color: #859900; font-weight: bold;">if</span> (region-active-p) (region-end)
                  (<span style="color: #859900; font-weight: bold;">progn</span>
                    (org-end-of-subtree)
                    (point))))
           (html (concat <span style="color: #2aa198;">"--[[text/html"</span>
                         (<span style="color: #859900; font-weight: bold;">if</span> arg <span style="color: #2aa198;">""</span> <span style="color: #2aa198;">"\nContent-Disposition: attachment"</span>)
                         <span style="color: #2aa198;">"]]\n"</span>
                         (org-export-region-as-html beg end t 'string))))
      (<span style="color: #859900; font-weight: bold;">when</span> (fboundp 'x-set-selection)
        (<span style="color: #859900; font-weight: bold;">ignore-errors</span> (x-set-selection 'PRIMARY html))
        (<span style="color: #859900; font-weight: bold;">ignore-errors</span> (x-set-selection 'CLIPBOARD html)))
      (message <span style="color: #2aa198;">"html export done, pushed to kill ring and clipboard"</span>))))
</pre>


</div>

</div>

<div id="outline-container-2-6-3" class="outline-4">
<h4 id="sec-2-6-3">Adopting for Gnus</h4>
<div class="outline-text-4" id="text-2-6-3">


<p>
The whole magic lies in the special strings that mark a HTML
attachment.  So you might just have to find out what these special
strings are in message-mode and modify the functions accordingly.
</p></div>
</div>

</div>

<div id="outline-container-2-7" class="outline-3">
<h3 id="sec-2-7">Add sunrise/sunset times to the agenda.</h3>
<div class="outline-text-3" id="text-2-7">

<p>  &ndash; Nick Dokos
</p>
<p>
The diary package provides the function <code>diary-sunrise-sunset</code> which can be used
in a diary s-expression in some agenda file like this:
</p>



<pre class="src src-org-mode">%%(diary-sunrise-sunset)
</pre>


<p>
Seb Vauban asked if it is possible to put sunrise and sunset in
separate lines. Here is a hack to do that. It adds two functions (they
have to be available before the agenda is shown, so I add them early
in my org-config file which is sourced from .emacs, but you'll have to
suit yourself here) that just parse the output of
diary-sunrise-sunset, instead of doing the right thing which would be
to take advantage of the data structures that diary/solar.el provides.
In short, a hack - so perfectly suited for inclusion here :-)
</p>
<p>
The functions (and latitude/longitude settings which you have to modify for
your location) are as follows:
</p>



<pre class="src src-emacs-lisp">(setq calendar-latitude 40.3)
(setq calendar-longitude -71.0)
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">diary-sunrise</span> ()
  (<span style="color: #859900; font-weight: bold;">let</span> ((dss (diary-sunrise-sunset)))
    (<span style="color: #859900; font-weight: bold;">with-temp-buffer</span>
      (insert dss)
      (goto-char (point-min))
      (<span style="color: #859900; font-weight: bold;">while</span> (re-search-forward <span style="color: #2aa198;">" ([</span><span style="color: #657b83;">^</span><span style="color: #2aa198;">)]*)"</span> nil t)
        (replace-match <span style="color: #2aa198;">""</span> nil nil))
      (goto-char (point-min))
      (search-forward <span style="color: #2aa198;">","</span>)
      (buffer-substring (point-min) (match-beginning 0)))))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">diary-sunset</span> ()
  (<span style="color: #859900; font-weight: bold;">let</span> ((dss (diary-sunrise-sunset))
        start end)
    (<span style="color: #859900; font-weight: bold;">with-temp-buffer</span>
      (insert dss)
      (goto-char (point-min))
      (<span style="color: #859900; font-weight: bold;">while</span> (re-search-forward <span style="color: #2aa198;">" ([</span><span style="color: #657b83;">^</span><span style="color: #2aa198;">)]*)"</span> nil t)
        (replace-match <span style="color: #2aa198;">""</span> nil nil))
      (goto-char (point-min))
      (search-forward <span style="color: #2aa198;">", "</span>)
      (setq start (match-end 0))
      (search-forward <span style="color: #2aa198;">" at"</span>)
      (setq end (match-beginning 0))
      (goto-char start)
      (capitalize-word 1)
      (buffer-substring start end))))
</pre>


<p>
You also need to add a couple of diary s-expressions in one of your agenda
files:
</p>



<pre class="src src-org-mode">%%(diary-sunrise)
%%(diary-sunset)
</pre>


<p>
The thread on the mailing list that started this can be found <a href="http://thread.gmane.org/gmane.emacs.orgmode/38723Here is a pointer to the thread on the mailing list">here</a>.
In comparison to the version posted on the mailing list, this one
gets rid of the timezone information.
</p></div>

</div>

<div id="outline-container-2-8" class="outline-3">
<h3 id="sec-2-8">Export BBDB contacts to org-contacts.el</h3>
<div class="outline-text-3" id="text-2-8">

<p>Try this tool by Wes Hardaker:
</p>
<p>
<a href="http://www.hardakers.net/code/bbdb-to-org-contacts/">http://www.hardakers.net/code/bbdb-to-org-contacts/</a>
</p>
</div>

</div>

<div id="outline-container-2-9" class="outline-3">
<h3 id="sec-2-9">Calculating date differences - how to write a simple elisp function</h3>
<div class="outline-text-3" id="text-2-9">


<p>
Alexander Wingård asked how to calculate the number of days between a
time stamp in his org file and today (see
<a href="http://thread.gmane.org/gmane.emacs.orgmode/46881">http://thread.gmane.org/gmane.emacs.orgmode/46881</a>).  Although the
resulting answer is probably not of general interest, the method might
be useful to a budding Elisp programmer.
</p>
<p>
Alexander started from an already existing org function,
<code>org-evaluate-time-range</code>.  When this function is called in the context
of a time range (two time stamps separated by "<code>--</code>"), it calculates the
number of days between the two dates and outputs the result in Emacs's
echo area. What he wanted was a similar function that, when called from
the context of a single time stamp, would calculate the number of days
between the date in the time stamp and today. The result should go to
the same place: Emacs's echo area.
</p>
<p>
The solution presented in the mail thread is as follows:
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">aw/org-evaluate-time-range</span> (<span style="color: #b58900;">&amp;optional</span> to-buffer)
  (interactive)
  (<span style="color: #859900; font-weight: bold;">if</span> (org-at-date-range-p t)
      (org-evaluate-time-range to-buffer)
    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">otherwise, make a time range in a temp buffer and run o-e-t-r there</span>
    (<span style="color: #859900; font-weight: bold;">let</span> ((headline (buffer-substring (point-at-bol) (point-at-eol))))
      (<span style="color: #859900; font-weight: bold;">with-temp-buffer</span>
   (insert headline)
   (goto-char (point-at-bol))
   (re-search-forward org-ts-regexp (point-at-eol) t)
   (<span style="color: #859900; font-weight: bold;">if</span> (not (org-at-timestamp-p t))
       (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span> <span style="color: #2aa198;">"No timestamp here"</span>))
   (goto-char (match-beginning 0))
   (org-insert-time-stamp (current-time) nil nil)
   (insert <span style="color: #2aa198;">"--"</span>)
   (org-evaluate-time-range to-buffer)))))
</pre>


<p>
The function assumes that point is on some line with some time stamp
(or a date range) in it. Note that <code>org-evaluate-time-range</code> does not care
whether the first date is earlier than the second: it will always output
the number of days between the earlier date and the later date.
</p>
<p>
As stated before, the function itself is of limited interest (although
it satisfied Alexander's need).The <b>method</b> used might be of wider
interest however, so here is a short explanation.
</p>
<p>
The idea is that we want <code>org-evaluate-time-range</code> to do all the
heavy lifting, but that function requires that it be in a date-range
context. So the function first checks whether it's in a date range
context already: if so, it calls <code>org-evaluate-time-range</code> directly
to do the work. The trick now is to arrange things so we can call this
same function in the case where we do <b>not</b> have a date range
context. In that case, we manufacture one: we create a temporary
buffer, copy the line with the purported time stamp to the temp
buffer, find the time stamp (signal an error if no time stamp is
found) and insert a new time stamp with the current time before the
existing time stamp, followed by "<code>--</code>": voilà, we now have a time range
on which we can apply our old friend <code>org-evaluate-time-range</code> to
produce the answer. Because of the above-mentioned property
of <code>org-evaluate-time-range</code>, it does not matter if the existing
time stamp is earlier or later than the current time: the correct
number of days is output.
</p>
<p>
Note that at the end of the call to <code>with-temp-buffer</code>, the temporary
buffer goes away.  It was just used as a scratch pad for the function
to do some figuring.
</p>
<p>
The idea of using a temp buffer as a scratch pad has wide
applicability in Emacs programming. The rest of the work is knowing
enough about facilities provided by Emacs (e.g. regexp searching) and
by Org (e.g. checking for time stamps and generating a time stamp) so
that you don't reinvent the wheel, and impedance-matching between the
various pieces.
</p>
</div>
</div>

</div>

<div id="outline-container-3" class="outline-2">
<h2 id="sec-3">Hacking Org: Working with Org-mode and External Programs.</h2>
<div class="outline-text-2" id="text-3">


</div>

<div id="outline-container-3-1" class="outline-3">
<h3 id="sec-3-1">Use Org-mode with Screen [Andrew Hyatt]</h3>
<div class="outline-text-3" id="text-3-1">

<p>"The general idea is that you start a task in which all the work will
take place in a shell.  This usually is not a leaf-task for me, but
usually the parent of a leaf task.  From a task in your org-file, M-x
ash-org-screen will prompt for the name of a session.  Give it a name,
and it will insert a link.  Open the link at any time to go the screen
session containing your work!"
</p>
<p>
<a href="http://article.gmane.org/gmane.emacs.orgmode/5276">http://article.gmane.org/gmane.emacs.orgmode/5276</a>
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">require</span> '<span style="color: #268bd2; font-weight: bold;">term</span>)

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ash-org-goto-screen</span> (name)
  <span style="color: #2aa198; font-style: italic;">"Open the screen with the specified name in the window"</span>
  (interactive <span style="color: #2aa198;">"MScreen name: "</span>)
  (<span style="color: #859900; font-weight: bold;">let</span> ((screen-buffer-name (ash-org-screen-buffer-name name)))
    (<span style="color: #859900; font-weight: bold;">if</span> (member screen-buffer-name
                (mapcar 'buffer-name (buffer-list)))
        (switch-to-buffer screen-buffer-name)
      (switch-to-buffer (ash-org-screen-helper name <span style="color: #2aa198;">"-dr"</span>)))))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ash-org-screen-buffer-name</span> (name)
  <span style="color: #2aa198; font-style: italic;">"Returns the buffer name corresponding to the screen name given."</span>
  (concat <span style="color: #2aa198;">"*screen "</span> name <span style="color: #2aa198;">"*"</span>))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ash-org-screen-helper</span> (name arg)
  <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Pick the name of the new buffer.</span>
  (<span style="color: #859900; font-weight: bold;">let</span> ((term-ansi-buffer-name
    (generate-new-buffer-name
     (ash-org-screen-buffer-name name))))
    (setq term-ansi-buffer-name
          (term-ansi-make-term
      term-ansi-buffer-name <span style="color: #2aa198;">"/usr/bin/screen"</span> nil arg name))
    (set-buffer term-ansi-buffer-name)
    (term-mode)
    (term-char-mode)
    (term-set-escape-char ?\C-x)
    term-ansi-buffer-name))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">ash-org-screen</span> (name)
  <span style="color: #2aa198; font-style: italic;">"Start a screen session with name"</span>
  (interactive <span style="color: #2aa198;">"MScreen name: "</span>)
  (<span style="color: #859900; font-weight: bold;">save-excursion</span>
    (ash-org-screen-helper name <span style="color: #2aa198;">"-S"</span>))
  (insert-string (concat <span style="color: #2aa198;">"[[screen:"</span> name <span style="color: #2aa198;">"]]"</span>)))

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">And don't forget to add ("screen" . "elisp:(ash-org-goto-screen</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">\"%s\")") to org-link-abbrev-alist.</span>
</pre>


</div>

</div>

<div id="outline-container-org-agenda-appt-zenity" class="outline-3">
<h3 id="org-agenda-appt-zenity"><a name="sec-3-2" id="sec-3-2"></a>Org Agenda + Appt + Zenity</h3>
<div class="outline-text-3" id="text-org-agenda-appt-zenity">




<a name="agenda-appt-zenity"></a>
<p>
Russell Adams posted this setup <a href="http://article.gmane.org/gmane.emacs.orgmode/5806">on the list</a>.  It makes sure your agenda
appointments are known by Emacs, and it displays warnings in a <a href="http://live.gnome.org/Zenity">zenity</a>
popup window.
</p>



<pre class="src src-emacs-lisp"><span style="color: #93a1a1;">;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">For org appointment reminders</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Get appointments for today</span>
(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-agenda-to-appt</span> ()
  (interactive)
  (setq appt-time-msg-list nil)
  (<span style="color: #859900; font-weight: bold;">let</span> ((org-deadline-warning-days 0))    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">will be automatic in org 5.23</span>
        (org-agenda-to-appt)))

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">Run once, activate and schedule refresh</span>
(my-org-agenda-to-appt)
(appt-activate t)
(run-at-time <span style="color: #2aa198;">"24:01"</span> nil 'my-org-agenda-to-appt)

<span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">5 minute warnings</span>
(setq appt-message-warning-time 15)
(setq appt-display-interval 5)

<span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">Update appt each time agenda opened.</span>
(add-hook 'org-finalize-agenda-hook 'my-org-agenda-to-appt)

<span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">Setup zenify, we tell appt to use window, and replace default function</span>
(setq appt-display-format 'window)
(setq appt-disp-window-function (function my-appt-disp-window))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-appt-disp-window</span> (min-to-app new-time msg)
  (<span style="color: #859900; font-weight: bold;">save-window-excursion</span> (shell-command (concat
    <span style="color: #2aa198;">"/usr/bin/zenity --info --title='Appointment' --text='"</span>
    msg <span style="color: #2aa198;">"' &amp;"</span>) nil nil)))
</pre>


</div>

</div>

<div id="outline-container-3-3" class="outline-3">
<h3 id="sec-3-3">Org-Mode + gnome-osd</h3>
<div class="outline-text-3" id="text-3-3">

<p>Richard Riley uses gnome-osd in interaction with Org-Mode to display
appointments.  You can look at the code on the <a href="http://www.emacswiki.org/emacs-en/OrgMode-OSD">emacswiki</a>.
</p>
</div>

</div>

<div id="outline-container-3-4" class="outline-3">
<h3 id="sec-3-4">remind2org</h3>
<div class="outline-text-3" id="text-3-4">

<p>From Detlef Steuer
</p>
<p>
<a href="http://article.gmane.org/gmane.emacs.orgmode/5073">http://article.gmane.org/gmane.emacs.orgmode/5073</a>
</p>
<blockquote>

<p>Remind (<a href="http://www.roaringpenguin.com/products/remind">http://www.roaringpenguin.com/products/remind</a>) is a very powerful
command line calendaring program. Its features supersede the possibilities
of orgmode in the area of date specifying, so that I want to use it
combined with orgmode.
</p>
<p>
Using the script below I'm able use remind and incorporate its output in my
agenda views.  The default of using 13 months look ahead is easily
changed. It just happens I sometimes like to look a year into the
future. :-)
</p>
</blockquote>


</div>

</div>

<div id="outline-container-3-5" class="outline-3">
<h3 id="sec-3-5">Useful webjumps for conkeror</h3>
<div class="outline-text-3" id="text-3-5">

<p>If you are using the <a href="http://conkeror.org">conkeror browser</a>, maybe you want to put this into
your <code>~/.conkerorrc</code> file:
</p>



<pre class="example">define_webjump("orglist", "http://search.gmane.org/?query=%s&amp;group=gmane.emacs.orgmode");
define_webjump("worg", "http://www.google.com/cse?cx=002987994228320350715%3Az4glpcrritm&amp;ie=UTF-8&amp;q=%s&amp;sa=Search&amp;siteurl=orgmode.org%2Fworg%2F");
</pre>


<p>
It creates two <a href="http://conkeror.org/Webjumps">webjumps</a> for easily searching the Worg website and the
Org-mode mailing list.
</p>
</div>

</div>

<div id="outline-container-3-6" class="outline-3">
<h3 id="sec-3-6">Use MathJax for HTML export without requiring JavaScript</h3>
<div class="outline-text-3" id="text-3-6">

<p>As of 2010-08-14, MathJax is the default method used to export math to HTML.
</p>
<p>
If you like the results but do not want JavaScript in the exported pages,
check out <a href="http://www.jboecker.de/2010/08/15/staticmathjax.html">Static MathJax</a>, a XULRunner application which generates a static
HTML file from the exported version. It can also embed all referenced fonts
within the HTML file itself, so there are no dependencies to external files.
</p>
<p>
The download archive contains an elisp file which integrates it into the Org
export process (configurable per file with a "#+StaticMathJax:" line).
</p>
<p>
Read README.org and the comments in org-static-mathjax.el for usage instructions.
</p></div>

</div>

<div id="outline-container-3-7" class="outline-3">
<h3 id="sec-3-7">Search Org files using lgrep</h3>
<div class="outline-text-3" id="text-3-7">

<p>Matt Lundin suggests this:
</p>



<pre class="src src-emacs-lisp">  (<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-grep</span> (search <span style="color: #b58900;">&amp;optional</span> context)
    <span style="color: #2aa198; font-style: italic;">"Search for word in org files.</span>

<span style="color: #2aa198; font-style: italic;">Prefix argument determines number of lines."</span>
    (interactive <span style="color: #2aa198;">"sSearch for: \nP"</span>)
    (<span style="color: #859900; font-weight: bold;">let</span> ((grep-find-ignored-files '(<span style="color: #2aa198;">"#*"</span> <span style="color: #2aa198;">".#*"</span>))
     (grep-template (concat <span style="color: #2aa198;">"grep &lt;X&gt; -i -nH "</span>
             (<span style="color: #859900; font-weight: bold;">when</span> context
               (concat <span style="color: #2aa198;">"-C"</span> (number-to-string context)))
             <span style="color: #2aa198;">" -e &lt;R&gt; &lt;F&gt;"</span>)))
      (lgrep search <span style="color: #2aa198;">"*org*"</span> <span style="color: #2aa198;">"/home/matt/org/"</span>)))

  (global-set-key (kbd <span style="color: #2aa198;">"&lt;f8&gt;"</span>) 'my-org-grep)
</pre>


</div>

</div>

<div id="outline-container-3-8" class="outline-3">
<h3 id="sec-3-8">Automatic screenshot insertion</h3>
<div class="outline-text-3" id="text-3-8">

<p>Suggested by Russell Adams
</p>



<pre class="src src-emacs-lisp">(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-screenshot</span> ()
  <span style="color: #2aa198; font-style: italic;">"Take a screenshot into a time stamped unique-named file in the</span>
<span style="color: #2aa198; font-style: italic;">same directory as the org-buffer and insert a link to this file."</span>
  (interactive)
  (setq filename
        (concat
         (make-temp-name
          (concat (buffer-file-name)
                  <span style="color: #2aa198;">"_"</span>
                  (format-time-string <span style="color: #2aa198;">"%Y%m%d_%H%M%S_"</span>)) ) <span style="color: #2aa198;">".png"</span>))
  (call-process <span style="color: #2aa198;">"import"</span> nil nil nil filename)
  (insert (concat <span style="color: #2aa198;">"[["</span> filename <span style="color: #2aa198;">"]]"</span>))
  (org-display-inline-images))
</pre>


</div>

</div>

<div id="outline-container-3-9" class="outline-3">
<h3 id="sec-3-9">Capture invitations/appointments from MS Exchange emails</h3>
<div class="outline-text-3" id="text-3-9">

<p>Dirk-Jan C.Binnema <a href="http://article.gmane.org/gmane.emacs.orgmode/27684/">provided</a> code to do this.  Please check
<a href="code/elisp/org-exchange-capture.el">org-exchange-capture.el</a>
</p>
</div>

</div>

<div id="outline-container-3-10" class="outline-3">
<h3 id="sec-3-10">Audio/video file playback within org mode</h3>
<div class="outline-text-3" id="text-3-10">

<p>Paul Sexton provided code that makes <code>file:</code> links to audio or video files
(MP3, WAV, OGG, AVI, MPG, et cetera) play those files using the <a href="https://github.com/dbrock/bongo">Bongo</a> Emacs
media player library. The user can pause, skip forward and backward in the
track, and so on from without leaving Emacs. Links can also contain a time
after a double colon &ndash; when this is present, playback will begin at that
position in the track.
</p>
<p>
See the file <a href="code/elisp/org-player.el">org-player.el</a>
</p>
</div>

</div>

<div id="outline-container-3-11" class="outline-3">
<h3 id="sec-3-11">Under X11 Keep a window with the current agenda items at all time</h3>
<div class="outline-text-3" id="text-3-11">

<p>I struggle to keep (in emacs) a window with the agenda at all times.
For a long time I have wanted a sticky window that keeps this
information, and then use my window manager to place it and remove its
decorations (I can also force its placement in the stack: top always,
for example).
</p>
<p>
I wrote a small program in qt that simply monitors an HTML file and
displays it. Nothing more. It does the work for me, and maybe somebody
else will find it useful. It relies on exporting the agenda as HTML
every time the org file is saved, and then this little program
displays the html file. The window manager is responsible of removing
decorations, making it sticky, and placing it in same place always.
</p>
<p>
Here is a screenshot (see window to the bottom right). The decorations
are removed by the window manager:
</p>
<p>
<img src="http://turingmachine.org/hacking/org-mode/orgdisplay.png"  alt="http://turingmachine.org/hacking/org-mode/orgdisplay.png" />
</p>
<p>
Here is the code. As I said, very, very simple, but maybe somebody will
find if useful.
</p>
<p>
<a href="http://turingmachine.org/hacking/org-mode/">http://turingmachine.org/hacking/org-mode/</a>
</p>
<p>
&ndash;daniel german
</p>
</div>

</div>

<div id="outline-container-3-12" class="outline-3">
<h3 id="sec-3-12">Script (thru procmail) to output emails to an Org file</h3>
<div class="outline-text-3" id="text-3-12">

<p>Tycho Garen sent <a href="http://comments.gmane.org/gmane.emacs.orgmode/44773">this</a>:
</p>
<pre class="example">
I've [...] created some procmail and shell glue that takes emails and
inserts them into an org-file so that I can capture stuff on the go using
the email program.
</pre>


<p>
Everything is documented <a href="http://tychoish.com/code/org-mail/">here</a>.
</p>
</div>

</div>

<div id="outline-container-fileconversion" class="outline-3">
<h3 id="fileconversion"><a name="sec-3-13" id="sec-3-13"></a>Save File With Different Format for Headings (fileconversion)</h3>
<div class="outline-text-3" id="text-fileconversion">


<p>
Using hooks and on the fly
</p><ul>
<li>when writing a buffer to the file replace the leading stars from headings
  with a file char
</li>
<li>when reading a file into the buffer replace the file chars with leading
  stars for headings
</li>
</ul>


<p>
To change to save an Org file in one of the formats or back just add or
remove the keyword in the STARTUP line and save.
</p>
<p>
Now you can also change to Fundamental mode to see how the file looks like
on the level of the file, go back to Org mode, reenter Org mode or change to
any other major mode and the conversion gets done whenever necessary.
</p>

</div>

<div id="outline-container-hidestarsfile" class="outline-4">
<h4 id="hidestarsfile"><a name="sec-3-13-1" id="sec-3-13-1"></a>Headings Without Leading Stars (hidestarsfile and nbspstarsfile)</h4>
<div class="outline-text-4" id="text-hidestarsfile">


<p>
This is like "a cleaner outline view":
<a href="http://orgmode.org/manual/Clean-view.html">http://orgmode.org/manual/Clean-view.html</a>
</p>
<p>
Example of the <span style="text-decoration:underline;">file content</span> first with leading stars as usual and below
without leading stars through "#+STARTUP: odd hidestars hidestarsfile":
</p>



<pre class="example">#+STARTUP: odd hidestars
[...]
***** TODO section
******* subsection
********* subsubsec
          - bla bla
***** section
      - bla bla
******* subsection
</pre>



<pre class="example">#+STARTUP: odd hidestars hidestarsfile
[...]
    * TODO section
      * subsection
        * subsubsec
          - bla bla
    * section
      - bla bla
      * subsection
</pre>


<p>
The latter is convenient for better human readability when an Org file,
additionally to Emacs, is read with a file viewer or, for smaller edits,
with an editor not capable of the Org file format.
</p>
<p>
hidestarsfile is a hack and can not become part of the Org core:
</p><ul>
<li>An Org file with hidestarsfile can not contain list items with a star as
  bullet due to the syntax conflict at read time. Mark E. Shoulson suggested
  to use the non-breaking space which is now implemented in fileconversion
  as nbspstarsfile as an alternative for hidestarsfile. Although I don't
  recommend it because an editor like typically e. g. Emacs may render the
  non-breaking space differently from the space 0x20.
</li>
<li>An Org file with hidestarsfile can almost not be edited with an Org mode
  without added functionality of hidestarsfile as long as the file is not
  converted back.
</li>
</ul>


</div>

</div>

<div id="outline-container-markdownstarsfile" class="outline-4">
<h4 id="markdownstarsfile"><a name="sec-3-13-2" id="sec-3-13-2"></a>Headings in Markdown Format (markdownstarsfile)</h4>
<div class="outline-text-4" id="text-markdownstarsfile">


<p>
For "oddeven" you can use markdownstarsfile to be readable or even basically
editable with Markdown (does not make much sense with "odd", see
org-convert-to-odd-levels and org-convert-to-oddeven-levels for how to
convert).
</p>
<p>
Example of the <span style="text-decoration:underline;">file content</span>:
</p>



<pre class="example">#+STARTUP: oddeven markdownstarsfile
# section level 1
  1. first item of numbered list (same format in Org and Markdown)
## section level 2
   - first item of unordered list (same format in Org and Markdown)
### section level 3
    + first item of unordered list (same format in Org and Markdown)
#### section level 4
     * first item of unordered list (same format in Org and Markdown)
     * avoid this item type to be compatible with Org hidestarsfile
</pre>


<p>
An Org file with markdownstarsfile can not contain code comment lines
prefixed with "#", even not when within source blocks.
</p>
</div>

</div>

<div id="outline-container-fileconversion-code" class="outline-4">
<h4 id="fileconversion-code"><a name="sec-3-13-3" id="sec-3-13-3"></a>emacs-lisp code</h4>
<div class="outline-text-4" id="text-fileconversion-code">





<pre class="src src-emacs-lisp"><span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">- fileconversion version 0.6</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">- DISCLAIMER: Make a backup of your Org files before using</span>
<span style="color: #93a1a1;">;;   </span><span style="color: #93a1a1;">my-org-fileconv-*.</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">- supported formats: hidestarsfile, markdownstarsfile</span>

<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">design summary: fileconversion is a round robin of two states</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">linked by two actions:</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">- state my-org-fileconv-level-org-p is nil: the level is "file"</span>
<span style="color: #93a1a1;">;;   </span><span style="color: #93a1a1;">(encoded)</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">- action my-org-fileconv-decode: replace file char with '*'</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">- state my-org-fileconv-level-org-p is t: the level is "Org"</span>
<span style="color: #93a1a1;">;;   </span><span style="color: #93a1a1;">(decoded)</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">- action my-org-fileconv-encode replace '*' with file char</span>

(<span style="color: #859900; font-weight: bold;">defvar</span> <span style="color: #268bd2;">my-org-fileconv-level-org-p</span> nil
  <span style="color: #2aa198; font-style: italic;">"Whether level of buffer is Org or only file.</span>
<span style="color: #2aa198; font-style: italic;">nil means the level is file (encoded), non-nil means the level is Org</span>
<span style="color: #dc322f; font-weight: bold; font-style: italic; text-decoration: underline;">(</span><span style="color: #2aa198; font-style: italic;">decoded)."</span>)
(make-variable-buffer-local 'my-org-fileconv-level-org-p)
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">survive a change of major mode that does kill-all-local-variables,</span>
<span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">e. g. when reentering Org mode through &#8220;C-c C-c&#8221; on a STARTUP line</span>
(put 'my-org-fileconv-level-org-p 'permanent-local t)

(add-hook 'org-mode-hook 'my-org-fileconv-init
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">_append_ to hook to have a higher chance that a message</span>
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">from this function will be visible as the last message in</span>
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">the minibuffer</span>
          t
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">hook addition global</span>
          nil)

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-fileconv-init</span> ()
  (interactive)
  <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">instrument only when converting really from/to an Org _file_, not</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">e. g. for a temp Org buffer unrelated to a file like used e. g.</span>
  <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">when calling the old Org exporter</span>
  (<span style="color: #859900; font-weight: bold;">when</span> (buffer-file-name)
    (message <span style="color: #2aa198;">"INF: my-org-fileconv-init, buffer: %s"</span> (buffer-name))
    (my-org-fileconv-decode)
    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">the hooks are not permanent-local, this way and as needed they</span>
    <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">will disappear when the major mode of the buffer changes</span>
    (add-hook 'change-major-mode-hook 'my-org-fileconv-encode nil
              <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">hook addition limited to buffer locally</span>
              t)
    (add-hook 'before-save-hook 'my-org-fileconv-encode nil
              <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">hook addition limited to buffer locally</span>
              t)
    (add-hook 'after-save-hook 'my-org-fileconv-decode nil
              <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">hook addition limited to buffer locally</span>
              t)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-fileconv-re</span> ()
  <span style="color: #2aa198; font-style: italic;">"Check whether there is a STARTUP line for fileconversion.</span>
<span style="color: #2aa198; font-style: italic;">If found then return the expressions required for the conversion."</span>
  (<span style="color: #859900; font-weight: bold;">save-excursion</span>
    (beginning-of-buffer)
    (<span style="color: #859900; font-weight: bold;">let</span> (re-list (count 0))
      (<span style="color: #859900; font-weight: bold;">while</span> (re-search-forward <span style="color: #2aa198;">"^#\\+STARTUP:"</span> nil t)
        <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">#+STARTUP: hidestarsfile</span>
        (<span style="color: #859900; font-weight: bold;">when</span> (string-match-p <span style="color: #2aa198;">"\\bhidestarsfile\\b"</span>
                              (thing-at-point 'line))
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">exclude e. g.:</span>
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">- line starting with star for bold emphasis</span>
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">- line of stars to underline section title in loosely</span>
          <span style="color: #93a1a1;">;;   </span><span style="color: #93a1a1;">quoted ASCII style (star at end of line)</span>
          (setq re-list '(<span style="color: #2aa198;">"</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">\\* </span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">"</span>  <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">common-re</span>
                          ?\ ))         <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">file-char</span>
          (setq count (1+ count)))
        <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">#+STARTUP: nbspstarsfile</span>
        (<span style="color: #859900; font-weight: bold;">when</span> (string-match-p <span style="color: #2aa198;">"\\bnbspstarsfile\\b"</span>
                              (thing-at-point 'line))
          (setq re-list '(<span style="color: #2aa198;">"</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;">\\* </span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">"</span>  <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">common-re</span>
                          ?\xa0))       <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">file-char non-breaking space</span>
          (setq count (1+ count)))
        <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">#+STARTUP: markdownstarsfile</span>
        (<span style="color: #859900; font-weight: bold;">when</span> (string-match-p <span style="color: #2aa198;">"\\bmarkdownstarsfile\\b"</span>
                              (thing-at-point 'line))
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">exclude e. g.:</span>
          <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">- #STARTUP:</span>
          (setq re-list '(<span style="color: #2aa198;">"</span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">(</span><span style="color: #2aa198;"> </span><span style="color: #2aa198; font-weight: bold;">\\</span><span style="color: #2aa198; font-weight: bold;">)</span><span style="color: #2aa198;">"</span>  <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">common-re</span>
                          ?#))       <span style="color: #93a1a1;">; </span><span style="color: #93a1a1;">file-char</span>
          (setq count (1+ count))))
      (<span style="color: #859900; font-weight: bold;">when</span> (&gt; count 1)
        (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span> <span style="color: #2aa198;">"ERR: more than one fileconversion found"</span>))
      re-list)))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-fileconv-decode</span> ()
  <span style="color: #2aa198; font-style: italic;">"In headings replace file char with '*'."</span>
  (<span style="color: #859900; font-weight: bold;">let</span> ((re-list (my-org-fileconv-re)))
    (<span style="color: #859900; font-weight: bold;">when</span> (and re-list (not my-org-fileconv-level-org-p))
      <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">no `</span><span style="color: #268bd2; font-weight: bold;">save-excursion</span><span style="color: #93a1a1;">' to be able to keep point in case of error</span>
      (<span style="color: #859900; font-weight: bold;">let*</span> ((common-re (nth 0 re-list))
             (file-char (nth 1 re-list))
             (file-re   (concat <span style="color: #2aa198;">"^"</span> (string file-char) <span style="color: #2aa198;">"+"</span> common-re))
             (org-re    (concat <span style="color: #2aa198;">"^\\*+"</span> common-re))
             len
             (p         (point)))
        (beginning-of-buffer)
        <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">syntax check</span>
        (<span style="color: #859900; font-weight: bold;">when</span> (re-search-forward org-re nil t)
          (goto-char (match-beginning 0))
          (org-reveal)
          (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span>
           <span style="color: #2aa198;">"ERR: my-org-fileconv-decode syntax conflict at point"</span>))
        (beginning-of-buffer)
        <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">substitution</span>
        (<span style="color: #859900; font-weight: bold;">with-silent-modifications</span>
          (<span style="color: #859900; font-weight: bold;">while</span> (re-search-forward file-re nil t)
            (goto-char (match-beginning 0))
            <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">faster than a lisp call of insert and delete on each</span>
            <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">single char</span>
            (setq len (- (match-beginning 1) (match-beginning 0)))
            (insert-char ?* len)
            (delete-char len)))
        (goto-char p))))

        <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">notes for ediff when only one file has fileconversion:</span>
        <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">- The changes to the buffer with fileconversion until here</span>
        <span style="color: #93a1a1;">;;   </span><span style="color: #93a1a1;">are not regarded by ediff-files because the first call to</span>
        <span style="color: #93a1a1;">;;   </span><span style="color: #93a1a1;">diff is made with the bare files directly. Only</span>
        <span style="color: #93a1a1;">;;   </span><span style="color: #93a1a1;">ediff-update-diffs and ediff-buffers write the decoded</span>
        <span style="color: #93a1a1;">;;   </span><span style="color: #93a1a1;">buffers to temp files and then call diff with them.</span>
        <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">- Workarounds (choose one):</span>
        <span style="color: #93a1a1;">;;   </span><span style="color: #93a1a1;">- after ediff-files first do a "!" (ediff-update-diffs)</span>
        <span style="color: #93a1a1;">;;     </span><span style="color: #93a1a1;">in the "*Ediff Control Panel*"</span>
        <span style="color: #93a1a1;">;;   </span><span style="color: #93a1a1;">- instead of using ediff-files first open the files and</span>
        <span style="color: #93a1a1;">;;     </span><span style="color: #93a1a1;">then run ediff-buffers (better for e. g. a script that</span>
        <span style="color: #93a1a1;">;;     </span><span style="color: #93a1a1;">takes two files as arguments and uses "emacs --eval")</span>

  <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">the level is Org most of all when no fileconversion is in effect</span>
  (setq my-org-fileconv-level-org-p t))

(<span style="color: #859900; font-weight: bold;">defun</span> <span style="color: #268bd2;">my-org-fileconv-encode</span> ()
  <span style="color: #2aa198; font-style: italic;">"In headings replace '*' with file char."</span>
  (<span style="color: #859900; font-weight: bold;">let</span> ((re-list (my-org-fileconv-re)))
    (<span style="color: #859900; font-weight: bold;">when</span> (and re-list my-org-fileconv-level-org-p)
      <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">no `</span><span style="color: #268bd2; font-weight: bold;">save-excursion</span><span style="color: #93a1a1;">' to be able to keep point in case of error</span>
      (<span style="color: #859900; font-weight: bold;">let*</span> ((common-re (nth 0 re-list))
             (file-char (nth 1 re-list))
             (file-re   (concat <span style="color: #2aa198;">"^"</span> (string file-char) <span style="color: #2aa198;">"+"</span> common-re))
             (org-re    (concat <span style="color: #2aa198;">"^\\*+"</span> common-re))
             len
             (p         (point)))
        (beginning-of-buffer)
        <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">syntax check</span>
        (<span style="color: #859900; font-weight: bold;">when</span> (re-search-forward file-re nil t)
          (goto-char (match-beginning 0))
          (org-reveal)
          (<span style="color: #dc322f; font-weight: bold; text-decoration: underline;">error</span>
           <span style="color: #2aa198;">"ERR: my-org-fileconv-encode syntax conflict at point"</span>))
        (beginning-of-buffer)
        <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">substitution</span>
        (<span style="color: #859900; font-weight: bold;">with-silent-modifications</span>
          (<span style="color: #859900; font-weight: bold;">while</span> (re-search-forward org-re nil t)
            (goto-char (match-beginning 0))
            <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">faster than a lisp call of insert and delete on each</span>
            <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">single char</span>
            (setq len (- (match-beginning 1) (match-beginning 0)))
            (insert-char file-char len)
            (delete-char len)))
        (goto-char p)
        (setq my-org-fileconv-level-org-p nil))))
  nil)  <span style="color: #93a1a1;">;; </span><span style="color: #93a1a1;">for the hook</span>
</pre>


<p>
Michael Brand
</p>
</div>
</div>

</div>

<div id="outline-container-3-14" class="outline-3">
<h3 id="sec-3-14">Meaningful diff for org files in a git repository</h3>
<div class="outline-text-3" id="text-3-14">

<p>Since most diff utilities are primarily meant for source code, it is
difficult to read diffs of text files like <code>.org</code> files easily. If you
version your org directory with a SCM like git you will know what I
mean. However for git, there is a way around. You can use
<code>gitattributes</code> to define a custom diff driver for org files. Then a
regular expression can be used to configure how the diff driver
recognises a "function".
</p>
<p>
Put the following in your <code>&lt;org_dir&gt;/.gitattributes</code>.
</p><pre class="example">
*.org  diff=org
</pre>

<p>Then put the following lines in <code>&lt;org_dir&gt;/.git/config</code>
</p><pre class="example">
[diff "org"]
 xfuncname = "^(\\*+ [a-zA-Z0-9]+.+)$"
</pre>


<p>
This will let you see diffs for org files with each hunk identified by
the unmodified headline closest to the changes. After the
configuration a diff should look something like the example below.
</p>



<pre class="example">diff --git a/org-hacks.org b/org-hacks.org
index a0672ea..92a08f7 100644
--- a/org-hacks.org
+++ b/org-hacks.org
@@ -2495,6 +2495,22 @@ ** Script (thru procmail) to output emails to an Org file
 
 Everything is documented [[http://tychoish.com/code/org-mail/][here]].
 
+** Meaningful diff for org files in a git repository
+
+Since most diff utilities are primarily meant for source code, it is
+difficult to read diffs of text files like ~.org~ files easily. If you
+version your org directory with a SCM like git you will know what I
+mean. However for git, there is a way around. You can use
+=gitattributes= to define a custom diff driver for org files. Then a
+regular expression can be used to configure how the diff driver
+recognises a "function".
+
+Put the following in your =&lt;org_dir&gt;/.gitattributes=.
+: *.org diff=org
+Then put the following lines in =&lt;org_dir&gt;/.git/config=
+: [diff "org"]
+:    xfuncname = "^(\\*+ [a-zA-Z0-9]+.+)$"
+
 * Musings
 
 ** Cooking?  Brewing?
</pre>


</div>
</div>

</div>

<div id="outline-container-4" class="outline-2">
<h2 id="sec-4">Musings</h2>
<div class="outline-text-2" id="text-4">



</div>

<div id="outline-container-4-1" class="outline-3">
<h3 id="sec-4-1">Cooking?  Brewing?</h3>
<div class="outline-text-3" id="text-4-1">

<p>See <a href="http://article.gmane.org/gmane.emacs.orgmode/44981">this message</a> from Erik Hetzner:
</p>
<p>
It currently does metric/english conversion, and a few other tricks.
Basically I just use calc’s units code.  I think scaling recipes, or
turning percentages into weights would be pretty easy.
</p>
<p>
  <a href="https://gitorious.org/org-cook/org-cook">https://gitorious.org/org-cook/org-cook</a>
</p>
<p>
There is also, for those interested:
</p>
<p>
  <a href="https://gitorious.org/org-brew/org-brew">https://gitorious.org/org-brew/org-brew</a>
</p>
<p>
for brewing beer. This is again, mostly just calc functions, including
hydrometer correction, abv calculation, priming sugar for a given CO<sub>2</sub>
volume, etc. More integration with org-mode should be possible: for
instance it would be nice to be able to use a lookup table (of ingredients)
to calculate target original gravity, IBUs, etc.
</p>
</div>
</div>
</div>
</div>

<div id="postamble">
<p class="date">Date: 2012-06-01T16:21+0200</p>
<p class="author">Author: Worg people</p>
<p class="creator"><a href="http://orgmode.org">Org</a> version 7.8.11 with <a href="http://www.gnu.org/software/emacs/">Emacs</a> version 24</p>
<a href="http://validator.w3.org/check?uri=referer">Validate XHTML 1.0</a>

</div>
</body>
</html>
